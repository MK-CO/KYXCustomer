# 关键词配置系统升级说明

## 概述

本次升级将原本硬编码的关键词和正则表达式规则改为数据库可配置模式，使系统更加灵活且易于维护。

## 升级内容

### 1. 数据库表设计

#### 1.1 关键词配置分类表 (`ai_keyword_categories`)
- 存储关键词配置的分类信息
- 支持分析类型和去噪类型的分类
- 字段包括：分类键名、中文名称、配置类型、描述等

#### 1.2 关键词配置表 (`ai_keyword_configs`)
- 存储具体的关键词、正则模式和排除条件
- 支持权重、风险级别等配置
- 字段包括：关键词类型、关键词内容、权重、风险级别等

#### 1.3 去噪模式配置表 (`ai_denoise_patterns`)
- 存储去噪过滤器的配置
- 支持正常操作、无效数据、系统关键词等类型
- 字段包括：模式名称、模式类型、模式内容、描述等

#### 1.4 配置版本管理表 (`ai_keyword_config_versions`)
- 支持配置的版本管理和回滚
- 存储配置快照和版本信息

### 2. 代码改造

#### 2.1 关键词配置管理器 (`app/services/keyword_config_manager.py`)
- 负责从数据库加载和管理配置
- 支持缓存机制，提高性能
- 提供配置增删改查的完整功能

#### 2.2 分析服务改造 (`app/services/stage2_analysis_service.py`)
- 修改`_init_keywords_config`为动态加载模式
- 新增`_load_keywords_config`方法从数据库加载配置
- 保留原硬编码配置作为备用方案（`_get_fallback_keywords_config`）
- 修改`keyword_screening`方法支持数据库会话参数

#### 2.3 去噪服务改造 (`app/services/content_denoiser.py`)
- 修改`__init__`方法为动态加载模式
- 新增`_load_denoise_config`方法从数据库加载配置
- 修改所有相关方法支持数据库会话参数
- 保留原硬编码配置作为备用方案

#### 2.4 API接口 (`app/api/keyword_config.py`)
- 提供完整的关键词配置管理API
- 支持分析配置和去噪配置的管理
- 包含配置导入导出、测试、统计等功能

### 3. 主要特性

#### 3.1 向后兼容
- 保留原硬编码配置作为备用方案
- 在数据库配置不可用时自动降级到默认配置
- 不影响现有功能的正常运行

#### 3.2 缓存机制
- 配置加载后缓存5分钟，提高性能
- 支持手动清空缓存
- 支持强制重新加载配置

#### 3.3 灵活配置
- 支持动态增删改查关键词
- 支持权重和风险级别配置
- 支持排除条件配置
- 支持启用/禁用配置项

#### 3.4 配置管理
- 提供Web API进行配置管理
- 支持配置导入导出
- 支持配置测试和统计
- 支持版本管理（预留）

## 数据库初始化

### 1. 创建表结构
```sql
-- 执行以下SQL文件
source sql/2024-12-30/create_keyword_config_tables.sql;
source sql/2024-12-30/create_denoise_config_data.sql;
```

### 2. 验证配置
```bash
# 重启应用后，检查配置是否正常加载
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/keyword-config/statistics
```

## API使用示例

### 1. 获取分析关键词配置
```bash
GET /api/keyword-config/analysis/categories
```

### 2. 添加关键词配置
```bash
POST /api/keyword-config/analysis/keywords
{
  "category_key": "urgent_urging",
  "keyword_type": "keyword",
  "keyword_value": "急死了",
  "weight": 0.9,
  "risk_level": "high",
  "description": "强烈催促词汇"
}
```

### 3. 测试关键词筛选
```bash
POST /api/keyword-config/test/keyword-screening
{
  "text": "车主又来催了，怎么样了？"
}
```

### 4. 获取去噪配置
```bash
GET /api/keyword-config/denoise/patterns?pattern_type=system_keyword
```

### 5. 清空配置缓存
```bash
POST /api/keyword-config/clear-cache
```

## 配置优先级

1. **数据库配置** - 优先使用数据库中的配置
2. **备用配置** - 数据库不可用时使用硬编码备用配置
3. **错误处理** - 配置加载失败时记录日志并使用备用配置

## 注意事项

### 1. 性能考虑
- 配置有5分钟缓存，修改配置后需等待缓存过期或手动清空缓存
- 建议在低峰期进行配置修改
- 大量配置修改时建议批量操作

### 2. 安全考虑
- 所有配置管理API都需要认证
- 建议定期备份配置数据
- 重要配置修改前建议先测试

### 3. 兼容性
- 原有的硬编码配置仍然保留，确保向后兼容
- 数据库格式和硬编码格式的字段映射已处理
- 升级过程中不会影响正在运行的分析任务

## 升级步骤

1. **停止应用**
   ```bash
   # 停止现有服务
   pkill -f main.py
   ```

2. **备份数据库**
   ```bash
   mysqldump -u username -p database_name > backup.sql
   ```

3. **执行数据库更新**
   ```bash
   mysql -u username -p database_name < sql/2024-12-30/create_keyword_config_tables.sql
   mysql -u username -p database_name < sql/2024-12-30/create_denoise_config_data.sql
   ```

4. **更新代码**
   ```bash
   git pull origin main
   # 或者手动部署新代码
   ```

5. **启动应用**
   ```bash
   python main.py
   ```

6. **验证功能**
   ```bash
   # 检查API是否正常
   curl http://localhost:8000/health
   
   # 检查配置是否加载
   curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/keyword-config/statistics
   ```

## 故障排除

### 1. 配置加载失败
- 检查数据库连接是否正常
- 检查数据库表是否存在
- 查看应用日志中的错误信息

### 2. API认证失败
- 确认Bearer Token是否正确
- 检查用户权限设置

### 3. 缓存问题
- 可通过API手动清空缓存
- 重启应用可清空所有缓存

## 后续计划

1. **配置版本管理** - 完善配置版本控制和回滚功能
2. **配置界面** - 开发Web界面进行可视化配置管理
3. **配置同步** - 支持多实例间的配置同步
4. **智能推荐** - 根据分析结果自动推荐配置优化

## 技术支持

如遇到问题，请联系开发团队并提供以下信息：
- 错误日志
- 配置详情
- 复现步骤
- 环境信息
