<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Platform Debug Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #5c64f4;
            --primary-hover: #4c54e4;
            --primary-light: #e6f3ff;
            --primary-ultra-light: #f8fbff;
            --success-color: #10b981;
            --success-light: #d1fae5;
            --warning-color: #f59e0b;
            --warning-light: #fef3c7;
            --danger-color: #ef4444;
            --danger-light: #fef2f2;
            --bg-primary: #e6f3ff;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f8fbff;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #8892a6;
            --border-color: #e1e5e9;
            --border-hover: #d1d5db;
            --border-focus: #5c64f4;
            --shadow-sm: 0 2px 8px rgba(92, 100, 244, 0.08);
            --shadow-md: 0 4px 16px rgba(92, 100, 244, 0.12);
            --shadow-lg: 0 8px 32px rgba(92, 100, 244, 0.15);
            --shadow-button: 0 2px 8px rgba(92, 100, 244, 0.2);
            --shadow-button-hover: 0 4px 16px rgba(92, 100, 244, 0.35);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            background: white;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .brand-logo::before {
            content: '';
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: relative;
        }

        .brand-logo::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border-color);
            background: #fafbfc;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .card-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .input, .select, .textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
        }

        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            margin-right: 6px;
            margin-bottom: 6px;
            outline: none;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            min-height: 32px;
            box-shadow: var(--shadow-button);
        }

        .button:last-child {
            margin-right: 0;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }

        .button:hover::before {
            width: 300px;
            height: 300px;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4a52e8 100%);
            color: white;
            border: 1px solid transparent;
        }

        .button-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-button-hover);
            background: linear-gradient(135deg, var(--primary-hover) 0%, #3d45d6 100%);
        }

        .button-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
            border: 1px solid transparent;
        }

        .button-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .button-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
            border: 1px solid transparent;
        }

        .button-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.35);
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .button-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
            border: 1px solid transparent;
        }

        .button-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.35);
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .button-outline {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
        }

        .button-outline:hover {
            background: var(--bg-hover);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-button);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .button:disabled::before {
            display: none;
        }

        /* ğŸ”¥ æ–°å¢ï¼šå°å°ºå¯¸æŒ‰é’®æ ·å¼ */
        .button-small {
            padding: 4px 8px;
            font-size: 11px;
            min-height: 24px;
            gap: 4px;
        }

        .button:active {
            transform: translateY(0) !important;
        }

        .result-container {
            grid-column: 1 / -1;
            margin-top: 1.5rem;
        }

        .result {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        .result-loading {
            background: #f0f9ff;
            border-color: #0ea5e9;
            color: #0c4a6e;
        }

        .result-success {
            background: #f0fdf4;
            border-color: var(--success-color);
            color: #14532d;
        }

        .result-error {
            background: #fef2f2;
            border-color: var(--danger-color);
            color: #991b1b;
        }

        .result-info {
            background: #f8fafc;
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .result-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-online {
            background: #dcfce7;
            color: #166534;
        }

        .status-offline {
            background: #fef2f2;
            color: #991b1b;
        }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .auth-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }

        .auth-card .card-header {
            background: rgba(245, 158, 11, 0.1);
            border-bottom-color: #f59e0b;
        }

        .toggle-fields {
            transition: all 0.3s ease;
        }

        .field-group {
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-top: 1rem;
            border: 1px solid var(--border-color);
        }

        .field-group h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="brand-logo"></div>
                    <div>
                        <h1>AIPlatform æ§åˆ¶å°</h1>
                        <p>æ™ºèƒ½åˆ†æç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</p>
                    </div>
                </div>
                
                <!-- è½®è¯¢çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="pollingStatus" style="display: none; background: var(--primary-light); padding: 10px 16px; border-radius: 12px; border: 1px solid var(--primary-color); font-size: 13px; box-shadow: var(--shadow-sm);">
                    <span style="color: var(--success-color); font-size: 16px; animation: pulse 2s infinite;">â—</span>
                    <span style="color: var(--text-primary); font-weight: 500; margin-left: 8px;">æ­£åœ¨ç›‘æ§ä»»åŠ¡è¿›åº¦...</span>
                    <button onclick="stopAllPolling()" class="button button-outline" style="margin-left: 12px; padding: 4px 12px; font-size: 11px;">
                        â¹ åœæ­¢ç›‘æ§
                    </button>
                </div>
                
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                </style>
            </div>
        </div>

        <!-- APIé…ç½®ï¼ˆéšè—ä½†ä¿ç•™åŠŸèƒ½ï¼‰ -->
        <div style="display: none;">
            <input type="password" id="apiKey" value="YWktcGxhdGZvcm0tc21hcnQtMjAyNC1lbmNyeXB0ZWQ=">
            <input type="text" id="baseUrl" value="http://localhost:8993">
            </div>

        <!-- Task Management Table -->
        <div class="result-container" id="taskTableContainer">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">âš™</div>
                        ä»»åŠ¡ç®¡ç†ä¸æ‰§è¡Œè®°å½•
                        <div style="margin-left: auto; display: flex; gap: 8px;">
                            <button onclick="refreshTaskConfigs()" class="button button-primary">
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="overflow-x: auto;">
                    <!-- ä»»åŠ¡é…ç½®è¡¨æ ¼ -->
                    <div id="taskConfigView" style="overflow-x: auto;">
                        <table id="taskConfigTable" style="width: 100%; min-width: 1200px; border-collapse: collapse; font-size: 13px; table-layout: fixed;">
                            <colgroup>
                                <col style="width: 18%;">
                                <col style="width: 10%;">
                                <col style="width: 12%;">
                                <col style="width: 10%;">
                                <col style="width: 12%;">
                                <col style="width: 12%;">
                                <col style="width: 10%;">
                                <col style="width: 16%;">
                            </colgroup>
                            <thead>
                                <tr style="background: var(--primary-ultra-light); border-bottom: 2px solid var(--border-focus);">
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ä»»åŠ¡åç§°</th>
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ç±»å‹</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">çŠ¶æ€æ§åˆ¶</th>
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">è°ƒåº¦é—´éš”</th>
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ä¸Šæ¬¡æ‰§è¡Œ</th>
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ä¸‹æ¬¡æ‰§è¡Œ</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">æ‰§è¡Œç»Ÿè®¡</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="taskConfigTableBody">
                                <tr>
                                    <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                        åŠ è½½ä»»åŠ¡é…ç½®ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>


                            </div>
                        </div>
                    </div>

        <!-- System Monitor Table -->
        <div class="result-container" id="systemMonitorContainer" style="margin-top: 2rem;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">âš¡</div>
                        ç³»ç»Ÿç›‘æ§
                        <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
                            <!-- ğŸš€ APScheduleræ€»å¼€å…³æ§åˆ¶ -->
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                                <span style="font-size: 12px; color: var(--text-secondary);">APScheduleræ€»å¼€å…³:</span>
                                <div id="masterSwitchStatus" style="font-size: 12px; font-weight: 600;">
                                    <span id="masterSwitchText">åŠ è½½ä¸­...</span>
                                </div>
                                <button id="masterSwitchToggle" onclick="toggleMasterSwitch()" 
                                        class="button button-small" 
                                        style="padding: 4px 8px; font-size: 11px; min-width: 50px;"
                                        disabled>
                                    åˆ‡æ¢
                                </button>
                            </div>
                            <button onclick="refreshSystemMonitor()" class="button button-primary">
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="overflow-x: auto;">
                    <div id="systemMonitorView" style="overflow-x: auto;">
                        <table id="systemMonitorTable" style="width: 100%; min-width: 1200px; border-collapse: collapse; font-size: 13px; table-layout: fixed;">
                            <colgroup>
                                <col style="width: 18%;">
                                <col style="width: 10%;">
                                <col style="width: 12%;">
                                <col style="width: 10%;">
                                <col style="width: 12%;">
                                <col style="width: 12%;">
                                <col style="width: 10%;">
                                <col style="width: 16%;">
                            </colgroup>
                            <thead>
                                <tr style="background: var(--primary-ultra-light); border-bottom: 2px solid var(--border-focus);">
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ç»„ä»¶åç§°</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">çŠ¶æ€</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">å½“å‰</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">æœ€å¤§</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ç­‰å¾…</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">å·²å®Œæˆ</th>
                                    <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ç±»å‹</th>
                                    <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">æè¿°</th>
                                </tr>
                            </thead>
                            <tbody id="systemMonitorTableBody">
                                <tr>
                                    <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                        åŠ è½½ç³»ç»Ÿç›‘æ§ä¿¡æ¯ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Records Modal -->
        <div id="taskRecordsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(92, 100, 244, 0.1); backdrop-filter: blur(8px); z-index: 10000; overflow-y: auto;">
            <div style="background: white; margin: 30px auto; max-width: 95%; width: 1400px; border-radius: 16px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);">
                <div style="padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--primary-ultra-light); border-radius: 16px 16px 0 0;">
                    <h3 id="taskRecordsModalTitle" style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">ä»»åŠ¡æ‰§è¡Œè®°å½•</h3>
                    <button onclick="closeTaskRecordsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 8px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='none'">Ã—</button>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                        <button onclick="refreshTaskRecordsModal()" class="button button-primary">ğŸ”„ åˆ·æ–°</button>
                        <span id="taskRecordsCount" style="color: var(--text-secondary); font-size: 14px; padding: 8px 12px; background: var(--primary-light); border-radius: 6px;"></span>
                    </div>
                    <div style="overflow-x: auto; max-height: 60vh; border: 1px solid var(--border-color); border-radius: 8px;">
                        <table id="taskRecordsModalTable" style="width: 100%; min-width: 1500px; border-collapse: collapse; font-size: 12px; table-layout: fixed;">
                            <colgroup>
                                <col style="width: 8%;">
                                <col style="width: 12%;">
                                <col style="width: 7%;">
                                <col style="width: 7%;">
                                <col style="width: 10%;">
                                <col style="width: 10%;">
                                <col style="width: 8%;">
                                <col style="width: 10%;">
                                <col style="width: 12%;">
                                <col style="width: 12%;">
                                <col style="width: 10%;">
                            </colgroup>
                            <thead>
                                <tr style="background: var(--primary-ultra-light); border-bottom: 2px solid var(--border-focus); position: sticky; top: 0;">
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ä»»åŠ¡ID</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ä»»åŠ¡åç§°</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">çŠ¶æ€</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">è§¦å‘æ–¹å¼</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">å¼€å§‹æ—¶é—´</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ç»“æŸæ—¶é—´</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">è€—æ—¶</th>
                                    <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">è¿›åº¦</th>
                                    <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">å¤„ç†è®°å½•</th>
                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: var(--text-primary); border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">è·³è¿‡åŸå› </th>
                                    <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="taskRecordsModalBody">
                                <tr>
                                    <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                        åŠ è½½ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Display -->
        <div class="result-container">
            <div id="result" class="result result-info">
                å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ“ä½œ...
            </div>
        </div>
            </div>

        <!-- æ—¥æœŸé€‰æ‹©æ¨¡æ€æ¡† -->
        <div id="dateSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(92, 100, 244, 0.1); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span style="color: var(--primary-color);">ğŸ“…</span>
                        é€‰æ‹©æ‰§è¡Œæ—¶é—´èŒƒå›´
                    </h3>
                    <button onclick="closeDateSelectionModal()" style="background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='none'">Ã—</button>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500; font-size: 14px;">
                            å¼€å§‹æ—¥æœŸ
                        </label>
                        <input type="date" id="taskStartDate" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='var(--border-focus)'; this.style.boxShadow='0 0 0 3px rgba(92, 100, 244, 0.1)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500; font-size: 14px;">
                            ç»“æŸæ—¥æœŸ
                        </label>
                        <input type="date" id="taskEndDate" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='var(--border-focus)'; this.style.boxShadow='0 0 0 3px rgba(92, 100, 244, 0.1)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                    
                    <div style="padding: 12px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>é€‰æ‹©è¦å¤„ç†çš„æ•°æ®æ—¶é—´èŒƒå›´ï¼Œç³»ç»Ÿå°†æŠ½å–è¯¥æ—¶é—´æ®µå†…çš„æ•°æ®å¹¶è¿›è¡Œåˆ†æ
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeDateSelectionModal()" class="button button-outline" style="margin: 0;">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmTaskExecution()" class="button button-primary" style="margin: 0;">
                        ğŸš€ æ‰§è¡Œä»»åŠ¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å–APIé…ç½®
        function getApiConfig() {
            return {
                baseUrl: document.getElementById('baseUrl').value.replace(/\/$/, ''),
                apiKey: document.getElementById('apiKey').value || 'YWktcGxhdGZvcm0tc21hcnQtMjAyNC1lbmNyeXB0ZWQ='
            };
        }

        // é€šç”¨APIè¯·æ±‚å‡½æ•°
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const config = getApiConfig();
            const url = `${config.baseUrl}${endpoint}`;
            
            // ä¼˜å…ˆä½¿ç”¨localStorageä¸­çš„tokenï¼Œå¦åˆ™ä½¿ç”¨é…ç½®çš„API Key
            const token = localStorage.getItem('auth_token') || config.apiKey;
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            try {
                showLoading();
                const response = await fetch(url, options);
                
                if (response.status === 429) {
                    // é™æµé”™è¯¯ç‰¹æ®Šå¤„ç†
                    try {
                        const errorResult = await response.json();
                        handleRateLimitError(errorResult);
                        return errorResult;
                    } catch (e) {
                        // å¦‚æœæ— æ³•è§£æJSONï¼Œä½¿ç”¨é»˜è®¤é™æµé”™è¯¯å¤„ç†
                        const errorData = {
                            success: false,
                            error_type: "RATE_LIMIT",
                            message: "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
                            status_code: 429
                        };
                        handleRateLimitError(errorData);
                        return errorData;
                    }
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    // å¯¹äºæˆåŠŸçš„å“åº”ï¼Œä¸æ˜¾ç¤ºç»“æœï¼ˆé¿å…å¹²æ‰°ç”¨æˆ·ç•Œé¢ï¼‰
                    hideLoading();
                } else {
                    showResult(result, 'error');
                }
                return result;
            } catch (error) {
                const errorData = {
                    error: error.message,
                    url: url,
                    timestamp: new Date().toISOString()
                };
                showResult(errorData, 'error');
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                return errorData;
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result result-loading';
            resultDiv.innerHTML = '<div class="loading-spinner"></div> å¤„ç†è¯·æ±‚ä¸­...';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const resultDiv = document.getElementById('result');
            if (resultDiv.className.includes('result-loading')) {
                resultDiv.className = 'result';
                resultDiv.innerHTML = '';
            }
        }

        // å¤„ç†é™æµé”™è¯¯çš„ä¸“é—¨å‡½æ•°
        function handleRateLimitError(errorData) {
            console.warn('ğŸš« è§¦å‘é™æµ:', errorData);
            
            const errorType = errorData.error_type || errorData.detail?.error_type || 'RATE_LIMIT';
            const message = errorData.message || errorData.detail?.message || 'è¯·æ±‚è¿‡äºé¢‘ç¹';
            const suggestion = errorData.suggestion || errorData.detail?.suggestion || 'è¯·ç¨åé‡è¯•';
            const retryAfter = errorData.retry_after_seconds || errorData.detail?.retry_after_seconds || 60;
            const limitValue = errorData.limit_value || errorData.detail?.limit_value;
            const limitType = errorData.limit_type || errorData.detail?.limit_type;
            
            // åˆ›å»ºå‹å¥½çš„é™æµæç¤º
            let rateLimitHtml = `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">âš ï¸</span>
                        <strong style="color: #856404;">è¯·æ±‚é¢‘ç‡é™åˆ¶</strong>
                    </div>
                    
                    <div style="color: #856404; margin-bottom: 1rem;">
                        <p style="margin: 0.5rem 0;"><strong>åŸå› :</strong> ${message}</p>
                        <p style="margin: 0.5rem 0;"><strong>å»ºè®®:</strong> ${suggestion}</p>
                        
                        ${limitType && limitValue ? `
                            <p style="margin: 0.5rem 0;"><strong>å½“å‰é™åˆ¶:</strong> ${limitValue} æ¬¡/${limitType === 'minute' ? 'åˆ†é’Ÿ' : limitType === 'hour' ? 'å°æ—¶' : 'å¤©'}</p>
                        ` : ''}
                        
                        <p style="margin: 0.5rem 0;"><strong>ç­‰å¾…æ—¶é—´:</strong> ${Math.ceil(retryAfter / 60)} åˆ†é’Ÿ</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="reloadSecurityConfig()" 
                                style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            é‡æ–°åŠ è½½é…ç½®
                        </button>
                        
                        <button onclick="checkCurrentLimits()" 
                                style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            æŸ¥çœ‹å½“å‰é™åˆ¶
                        </button>
                        
                        <div id="rateLimitTimer" style="margin-left: auto; font-size: 0.9rem; color: #856404;"></div>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºé™æµé”™è¯¯
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result result-warning';
            resultDiv.innerHTML = rateLimitHtml;
            
            // å¯åŠ¨å€’è®¡æ—¶
            startRetryTimer(retryAfter);
        }

        // å€’è®¡æ—¶å‡½æ•°
        function startRetryTimer(seconds) {
            const timerDiv = document.getElementById('rateLimitTimer');
            if (!timerDiv) return;
            
            let remainingSeconds = seconds;
            
            const updateTimer = () => {
                const minutes = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                timerDiv.textContent = `â° ${minutes}:${secs.toString().padStart(2, '0')} åå¯é‡è¯•`;
                
                if (remainingSeconds > 0) {
                    remainingSeconds--;
                    setTimeout(updateTimer, 1000);
                } else {
                    timerDiv.textContent = 'âœ… ç°åœ¨å¯ä»¥é‡è¯•äº†';
                    timerDiv.style.color = '#28a745';
                }
            };
            
            updateTimer();
        }

        // é‡æ–°åŠ è½½å®‰å…¨é…ç½®
        async function reloadSecurityConfig() {
            try {
                showResult('ğŸ”„ æ­£åœ¨é‡æ–°åŠ è½½é…ç½®...', 'info');
                const result = await fetch(`${getApiConfig().baseUrl}/api/v1/security/reload-config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || getApiConfig().apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await result.json();
                
                if (result.ok && data.success) {
                    showResult(`âœ… ${data.message}\n\næ–°çš„é…ç½®:\n${JSON.stringify(data.config, null, 2)}`, 'success');
                } else {
                    showResult(`âŒ é‡æ–°åŠ è½½é…ç½®å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ é‡æ–°åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹å½“å‰é™åˆ¶
        async function checkCurrentLimits() {
            try {
                showResult('ğŸ” æ­£åœ¨æŸ¥è¯¢å½“å‰é™åˆ¶...', 'info');
                const result = await fetch(`${getApiConfig().baseUrl}/api/v1/security/status`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || getApiConfig().apiKey}`
                    }
                });
                
                const data = await result.json();
                
                if (result.ok && data.success) {
                    const config = data.data.config || {};
                    const statusHtml = `
                        ğŸ“Š å½“å‰å®‰å…¨é…ç½®:
                        
                        ğŸ”’ é™æµçŠ¶æ€: ${config.rate_limit_enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}
                        ğŸ“… æ¯åˆ†é’Ÿé™åˆ¶: ${config.requests_per_minute || 'N/A'} æ¬¡
                        ğŸ• æ¯å°æ—¶é™åˆ¶: ${config.requests_per_hour || 'N/A'} æ¬¡  
                        ğŸ“† æ¯æ—¥é™åˆ¶: ${config.requests_per_day || 'N/A'} æ¬¡
                        
                        ğŸ” ç™»å½•å®‰å…¨:
                        ğŸ¯ æœ€å¤§å°è¯•æ¬¡æ•°: ${config.login_max_attempts || 'N/A'} æ¬¡
                        â° é”å®šæ—¶é•¿: ${config.lockout_duration_minutes || 'N/A'} åˆ†é’Ÿ
                    `;
                    showResult(statusHtml, 'info');
                } else {
                    showResult(`âŒ æŸ¥è¯¢é™åˆ¶å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ æŸ¥è¯¢é™åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(data, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result result-${type}`;
            
            if (typeof data === 'object') {
                resultDiv.textContent = JSON.stringify(data, null, 2);
            } else {
                resultDiv.innerHTML = data.replace(/\n/g, '<br>');
            }
        }



        // ===== ä»»åŠ¡ç®¡ç†åŠŸèƒ½ =====

        // åˆ·æ–°ç³»ç»Ÿç›‘æ§
        async function refreshSystemMonitor() {
            try {
                console.log('ğŸ”„ å¼€å§‹åˆ·æ–°ç³»ç»Ÿç›‘æ§...');
                
                // ğŸ”¥ æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = new Date().getTime();
                const result = await apiRequest(`/api/v1/system/performance/status?_t=${timestamp}`);
                
                console.log('ğŸ“Š ç³»ç»Ÿç›‘æ§APIå“åº”:', result);
                
                if (result && result.success) {
                    const performance = result.performance_status;
                    const concurrency = performance.concurrency;
                    const scheduler = performance.scheduler;
                    
                    // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æ€»å¼€å…³çŠ¶æ€æ˜¾ç¤º
                    updateMasterSwitchDisplay(scheduler.master_switch || {});
                    
                    // åˆ›å»ºç›‘æ§æ•°æ®è¡Œ
                    let monitorRows = [];
                    
                    // çº¿ç¨‹æ± çŠ¶æ€è¡Œ
                    monitorRows.push({
                        name: 'çº¿ç¨‹æ± ',
                        type: 'ThreadPool',
                        icon: 'ğŸ§µ',
                        status: concurrency.thread_pool.initialized ? 'è¿è¡Œä¸­' : 'æœªåˆå§‹åŒ–',
                        statusColor: concurrency.thread_pool.initialized ? 'success' : 'danger',
                        current: concurrency.thread_pool.initialized ? concurrency.thread_pool.active_threads : 0,
                        max: concurrency.thread_pool.initialized ? concurrency.thread_pool.max_workers : 0,
                        pending: concurrency.thread_pool.initialized ? (concurrency.thread_pool.pending_tasks || 0) : 0,
                        completed: '-',
                        description: concurrency.thread_pool.initialized ? 'I/Oå¯†é›†å‹ä»»åŠ¡æ‰§è¡Œæ± ' : 'çº¿ç¨‹æ± æœªåˆå§‹åŒ–'
                    });
                    
                    // å¼‚æ­¥ä»»åŠ¡çŠ¶æ€è¡Œ
                    monitorRows.push({
                        name: 'å¼‚æ­¥ä»»åŠ¡',
                        type: 'AsyncTasks',
                        icon: 'ğŸ“‹',
                        status: concurrency.async_tasks.running_tasks > 0 ? `${concurrency.async_tasks.running_tasks} è¿è¡Œä¸­` : 'ç©ºé—²',
                        statusColor: concurrency.async_tasks.running_tasks > 0 ? 'warning' : 'success',
                        current: concurrency.async_tasks.running_tasks,
                        max: 'âˆ',
                        pending: 0,
                        completed: concurrency.async_tasks.completed_tasks,
                        description: concurrency.async_tasks.running_task_ids.length > 0 ? 
                                    concurrency.async_tasks.running_task_ids.map(id => id.substring(0, 8)).join(', ') + '...' : 
                                    'åå°ä»»åŠ¡ç®¡ç†å™¨'
                    });
                    
                    // ğŸ”¥ è°ƒåº¦å™¨çŠ¶æ€è¡Œ - è€ƒè™‘æ€»å¼€å…³çŠ¶æ€
                    const masterSwitchEnabled = scheduler.master_switch?.enabled ?? scheduler.master_switch_enabled;
                    const isRunning = scheduler.is_running;
                    const enabledTasks = scheduler.enabled_tasks;
                    
                    // ğŸ”¥ è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºçŠ¶æ€å€¼
                    console.log('ğŸ”§ è°ƒåº¦å™¨çŠ¶æ€è°ƒè¯•:', {
                        masterSwitchEnabled,
                        isRunning,
                        enabledTasks,
                        rawMasterSwitch: scheduler.master_switch,
                        rawMasterSwitchEnabled: scheduler.master_switch_enabled
                    });
                    
                    let schedulerStatus, schedulerStatusColor, schedulerDescription;
                    
                    // ğŸ”¥ æœ€ç®€åŒ–é€»è¾‘ï¼šåªæ ¹æ®æ€»å¼€å…³çŠ¶æ€åˆ¤æ–­
                    if (masterSwitchEnabled) {
                        schedulerStatus = 'å¼€å¯';
                        schedulerStatusColor = 'success';
                        schedulerDescription = `APSchedulerå·²å¼€å¯ï¼Œ${enabledTasks}ä¸ªå¯ç”¨ä»»åŠ¡`;
                        console.log('ğŸ“Œ çŠ¶æ€åˆ¤æ–­ï¼šå¼€å¯ï¼ˆAPScheduleræ€»å¼€å…³å¼€å¯ï¼‰');
                    } else {
                        schedulerStatus = 'å…³é—­';
                        schedulerStatusColor = 'danger';
                        schedulerDescription = `APScheduleræ€»å¼€å…³å·²å…³é—­ï¼Œ${enabledTasks}ä¸ªä»»åŠ¡æš‚åœæ‰§è¡Œ`;
                        console.log('ğŸ“Œ çŠ¶æ€åˆ¤æ–­ï¼šå…³é—­ï¼ˆAPScheduleræ€»å¼€å…³å…³é—­ï¼‰');
                    }
                    
                    console.log('ğŸ¯ æœ€ç»ˆè°ƒåº¦å™¨çŠ¶æ€:', {
                        status: schedulerStatus,
                        color: schedulerStatusColor,
                        description: schedulerDescription
                    });
                    
                    monitorRows.push({
                        name: 'APSchedulerè°ƒåº¦å™¨',
                        type: 'APScheduler',
                        icon: 'ğŸ”„',
                        status: schedulerStatus,
                        statusColor: schedulerStatusColor,
                        current: scheduler.active_tasks,
                        max: enabledTasks,
                        pending: 0,
                        completed: '-',
                        description: schedulerDescription
                    });
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    console.log('ğŸ–¼ï¸ æ¸²æŸ“ç³»ç»Ÿç›‘æ§è¡¨æ ¼ï¼ŒåŒ…å«è°ƒåº¦å™¨çŠ¶æ€:', monitorRows[2]); // ç¬¬ä¸‰è¡Œæ˜¯è°ƒåº¦å™¨
                    renderSystemMonitorTable(monitorRows);
                } else {
                    const tbody = document.getElementById('systemMonitorTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                è·å–ç³»ç»Ÿç›‘æ§ä¿¡æ¯å¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('åˆ·æ–°ç³»ç»Ÿç›‘æ§å¤±è´¥:', error);
                const tbody = document.getElementById('systemMonitorTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            ç½‘ç»œé”™è¯¯: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // æ¸²æŸ“ç³»ç»Ÿç›‘æ§è¡¨æ ¼
        function renderSystemMonitorTable(monitorRows) {
            const tbody = document.getElementById('systemMonitorTableBody');
            
            console.log('ğŸ¨ æ­£åœ¨æ¸²æŸ“ç³»ç»Ÿç›‘æ§è¡¨æ ¼ï¼Œæ•°æ®è¡Œæ•°:', monitorRows.length);
            
            let html = '';
            monitorRows.forEach((row, index) => {
                if (index === 2) { // è°ƒåº¦å™¨è¡Œï¼ˆç¬¬ä¸‰è¡Œï¼‰
                    console.log('ğŸ¯ æ­£åœ¨æ¸²æŸ“è°ƒåº¦å™¨è¡Œ:', row);
                }
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); transition: all 0.2s ease; height: 60px;" 
                        onmouseover="this.style.background='var(--bg-hover)'; this.style.transform='translateX(2px)'" 
                        onmouseout="this.style.background='white'; this.style.transform='translateX(0)'">
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">${row.icon}</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 13px; line-height: 1.3;">${row.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted); line-height: 1.2;">${row.type}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; text-align: center;">
                            <span class="button button-${row.statusColor}" style="padding: 3px 8px; margin: 0; font-size: 11px; font-weight: 500; min-width: auto;">
                                ${row.status}
                            </span>
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; text-align: center; font-size: 12px; font-weight: 500; color: var(--text-primary);">
                            ${row.current}
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; text-align: center; font-size: 12px; color: var(--text-secondary);">
                            ${row.max}
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; text-align: center; font-size: 12px; color: var(--text-secondary);">
                            ${row.pending}
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; text-align: center; font-size: 12px; color: var(--text-secondary);">
                            ${row.completed}
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; text-align: center; font-size: 11px; color: var(--text-muted);">
                            ${row.type}
                        </td>
                        <td style="padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; font-size: 11px; color: var(--text-secondary);" title="${row.description}">
                            ${row.description}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // ğŸ”¥ å¼ºåˆ¶DOMåˆ·æ–°å’Œç¡®è®¤æ—¥å¿—
            tbody.offsetHeight; // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
            console.log('âœ… ç³»ç»Ÿç›‘æ§è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼ŒDOMå·²æ›´æ–°');
            
            // ğŸ”¥ éªŒè¯ç¬¬ä¸‰è¡Œï¼ˆè°ƒåº¦å™¨ï¼‰çš„å®é™…æ¸²æŸ“å†…å®¹
            setTimeout(() => {
                const schedulerRow = tbody.children[2]; // ç¬¬ä¸‰è¡Œ
                if (schedulerRow) {
                    const statusCell = schedulerRow.children[1]; // çŠ¶æ€åˆ—
                    const statusSpan = statusCell.querySelector('span');
                    console.log('ğŸ” éªŒè¯è°ƒåº¦å™¨è¡Œæ¸²æŸ“ç»“æœ:', {
                        statusText: statusSpan?.textContent,
                        statusClass: statusSpan?.className
                    });
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°è°ƒåº¦å™¨è¡Œ');
                }
            }, 100);
        }

        // ===== ğŸ”¥ æ€»å¼€å…³æ§åˆ¶åŠŸèƒ½ =====
        
        // æ›´æ–°æ€»å¼€å…³çŠ¶æ€æ˜¾ç¤º
        function updateMasterSwitchDisplay(masterSwitchInfo) {
            const statusText = document.getElementById('masterSwitchText');
            const toggleButton = document.getElementById('masterSwitchToggle');
            
            console.log('ğŸ”§ æ›´æ–°æ€»å¼€å…³æ˜¾ç¤º:', masterSwitchInfo);
            
            if (masterSwitchInfo && typeof masterSwitchInfo.enabled !== 'undefined') {
                const isEnabled = masterSwitchInfo.enabled;
                statusText.textContent = isEnabled ? 'å¼€å¯' : 'å…³é—­';
                statusText.style.color = isEnabled ? 'var(--success-color)' : 'var(--danger-color)';
                
                // å¯ç”¨åˆ‡æ¢æŒ‰é’®
                toggleButton.disabled = false;
                toggleButton.className = `button button-small ${isEnabled ? 'button-warning' : 'button-success'}`;
                toggleButton.textContent = isEnabled ? 'å…³é—­' : 'å¼€å¯';
                
                console.log('âœ… æ€»å¼€å…³æ˜¾ç¤ºå·²æ›´æ–°:', {
                    enabled: isEnabled,
                    statusText: statusText.textContent,
                    buttonText: toggleButton.textContent
                });
            } else {
                statusText.textContent = 'æœªçŸ¥';
                statusText.style.color = 'var(--text-muted)';
                toggleButton.disabled = true;
                toggleButton.className = 'button button-small';
                toggleButton.textContent = 'åˆ‡æ¢';
                
                console.warn('âš ï¸ æ€»å¼€å…³ä¿¡æ¯æ— æ•ˆ:', masterSwitchInfo);
            }
        }
        
        // åˆ‡æ¢æ€»å¼€å…³çŠ¶æ€
        async function toggleMasterSwitch() {
            const toggleButton = document.getElementById('masterSwitchToggle');
            const originalText = toggleButton.textContent;
            const originalClass = toggleButton.className;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                toggleButton.disabled = true;
                toggleButton.textContent = 'åˆ‡æ¢ä¸­...';
                toggleButton.className = 'button button-small';
                
                const result = await apiRequest('/api/v1/system/scheduler/master-switch/toggle', 'POST');
                
                if (result && result.success) {
                    // æ›´æ–°æ˜¾ç¤º
                    updateMasterSwitchDisplay(result.master_switch);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showResult(`âœ… ${result.message}`, 'success');
                    
                    // ğŸ”¥ ç«‹å³åˆ·æ–°ç³»ç»Ÿç›‘æ§ï¼ˆæ— å»¶è¿Ÿï¼‰
                    console.log('ğŸ”„ æ€»å¼€å…³åˆ‡æ¢æˆåŠŸï¼Œç«‹å³åˆ·æ–°ç³»ç»Ÿç›‘æ§...');
                    await refreshSystemMonitor();
                    
                    // ğŸ”¥ å†æ¬¡å»¶è¿Ÿåˆ·æ–°ç¡®ä¿çŠ¶æ€åŒæ­¥
                    setTimeout(async () => {
                        console.log('ğŸ”„ å»¶è¿Ÿå†æ¬¡åˆ·æ–°ç³»ç»Ÿç›‘æ§...');
                        await refreshSystemMonitor();
                    }, 500);
                } else {
                    throw new Error(result?.message || 'åˆ‡æ¢å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ€»å¼€å…³å¤±è´¥:', error);
                showResult(`âŒ åˆ‡æ¢æ€»å¼€å…³å¤±è´¥: ${error.message}`, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                toggleButton.disabled = false;
                toggleButton.textContent = originalText;
                toggleButton.className = originalClass;
            }
        }
        
        // è·å–æ€»å¼€å…³çŠ¶æ€ï¼ˆç‹¬ç«‹è°ƒç”¨ï¼‰
        async function loadMasterSwitchStatus() {
            try {
                const result = await apiRequest('/api/v1/system/scheduler/master-switch');
                
                if (result && result.success) {
                    updateMasterSwitchDisplay(result.master_switch);
                    return result.master_switch;
                } else {
                    console.warn('è·å–æ€»å¼€å…³çŠ¶æ€å¤±è´¥:', result?.message);
                    return null;
                }
            } catch (error) {
                console.error('åŠ è½½æ€»å¼€å…³çŠ¶æ€å¤±è´¥:', error);
                return null;
            }
        }

        // åˆ·æ–°ä»»åŠ¡é…ç½®
        async function refreshTaskConfigs() {
            try {
                console.log('ğŸ”„ å¼€å§‹åˆ·æ–°ä»»åŠ¡é…ç½®...');
                const result = await apiRequest('/api/v1/tasks/configs');
                console.log('ğŸ“¥ APIå“åº”:', result);
                
                if (result && result.success) {
                    console.log('âœ… æˆåŠŸè·å–ä»»åŠ¡é…ç½®:', result.data);
                    renderTaskConfigTable(result.data);
                } else {
                    console.warn('âš ï¸ APIè¿”å›å¤±è´¥:', result);
                    const tbody = document.getElementById('taskConfigTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-error);">
                                âŒ è·å–ä»»åŠ¡é…ç½®å¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}
                                <br><small>è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€æˆ–åˆ·æ–°é¡µé¢é‡è¯•</small>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('âŒ ä»»åŠ¡é…ç½®è¯·æ±‚å¼‚å¸¸:', error);
                const tbody = document.getElementById('taskConfigTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-error);">
                            âŒ ç½‘ç»œé”™è¯¯: ${error.message}
                            <br><small>è¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œæˆ–ç¨åé‡è¯•</small>
                            <br><button onclick="refreshTaskConfigs()" class="button button-primary" style="margin-top: 8px;">é‡è¯•</button>
                        </td>
                    </tr>
                `;
            }
        }

        // æ¸²æŸ“ä»»åŠ¡é…ç½®è¡¨æ ¼
        function renderTaskConfigTable(configs) {
            // ä¿å­˜é…ç½®æ•°æ®åˆ°å…¨å±€å˜é‡
            currentTaskConfigs = configs || [];
            
            const tbody = document.getElementById('taskConfigTableBody');
            
            if (!configs || configs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            æš‚æ— ä»»åŠ¡é…ç½®
                        </td>
                    </tr>
                `;
                    return;
                }
                
            tbody.innerHTML = configs.map(config => `
                <tr style="border-bottom: 1px solid var(--border-color); transition: all 0.2s ease; height: 60px;" onmouseover="this.style.background='var(--bg-hover)'; this.style.transform='translateX(2px)'" onmouseout="this.style.background='white'; this.style.transform='translateX(0)'">
                    <td style="padding: 10px; border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;" title="${config.task_description || config.task_name}">
                        <div style="font-weight: 600; color: var(--text-primary); font-size: 13px; line-height: 1.4; overflow: hidden; text-overflow: ellipsis;">${config.task_name}</div>
                        ${config.task_description ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis;">${config.task_description.length > 25 ? config.task_description.substring(0, 25) + '...' : config.task_description}</div>` : ''}
                    </td>
                    <td style="padding: 10px; border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;">
                        <span style="padding: 3px 8px; background: ${getTaskHandlerBadgeColor(config.task_handler)}; color: white; border-radius: 12px; font-size: 11px; font-weight: 500; white-space: nowrap; box-shadow: var(--shadow-sm);">
                            ${getTaskHandlerLabel(config.task_handler)}
                        </span>
                    </td>
                    <td style="padding: 10px; text-align: center; border-right: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle;">
                        <button onclick="toggleTaskEnabled('${config.task_key}', ${!config.is_enabled})" 
                                class="button ${config.is_enabled ? 'button-success' : 'button-danger'}" 
                                style="padding: 5px 12px; font-size: 11px; min-width: 60px; margin: 0;">
                            ${config.is_enabled ? 'âœ“ ç”Ÿæ•ˆ' : 'âœ— å¤±æ•ˆ'}
                        </button>
                    </td>
                    <td style="padding: 10px; border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; font-size: 12px; color: var(--text-secondary);">${formatScheduleDisplay(config)}</td>
                    <td style="padding: 10px; font-size: 11px; border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; color: var(--text-secondary);">${formatDateTime(config.last_execution_time)}</td>
                    <td style="padding: 10px; font-size: 11px; border-right: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; color: var(--text-secondary);">${formatDateTime(config.next_execution_time)}</td>
                    <td style="padding: 10px; text-align: center; border-right: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle;">
                        <div style="font-size: 11px; line-height: 1.3;">
                            <span style="color: var(--text-primary); font-weight: 600;">æ€»${config.execution_count}</span>
                            <span style="color: var(--success-color); margin-left: 4px;">âœ“${config.success_count}</span>
                            <span style="color: var(--danger-color); margin-left: 4px;">âœ—${config.failure_count}</span>
                        </div>
                    </td>
                    <td style="padding: 10px; text-align: center; white-space: nowrap; vertical-align: middle;">
                        <div style="display: flex; gap: 3px; justify-content: center; flex-wrap: nowrap;">
                            <button onclick="manualExecuteTask('${config.task_key}')" 
                                    class="button button-warning" 
                                    style="padding: 4px 8px; font-size: 10px; margin: 0;" 
                                    ${!config.is_enabled ? 'disabled' : ''}>
                                æ‰§è¡Œ
                            </button>
                            <button onclick="stopTaskExecution('${config.task_key}')" 
                                    class="button button-danger" 
                                    style="padding: 4px 8px; font-size: 10px; margin: 0;">
                                ç»ˆæ­¢
                            </button>
                            <button onclick="viewTaskRecords('${config.task_key}', '${config.task_name}')" 
                                    class="button button-primary" 
                                    style="padding: 4px 8px; font-size: 10px; margin: 0;">
                                è®°å½•
                            </button>
                            <button onclick="editTaskConfig('${config.task_key}')" 
                                    class="button button-outline" 
                                    style="padding: 4px 8px; font-size: 10px; margin: 0;">
                                ç¼–è¾‘
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // åˆ‡æ¢ä»»åŠ¡å¯ç”¨çŠ¶æ€
        async function toggleTaskEnabled(taskKey, enabled) {
            const statusText = enabled ? 'ç”Ÿæ•ˆ' : 'å¤±æ•ˆ';
            const confirmed = confirm(`ç¡®è®¤è®©ä»»åŠ¡ "${taskKey}" ${statusText}ï¼Ÿ`);
            if (!confirmed) return;

            try {
                const result = await apiRequest(`/api/v1/tasks/configs/${taskKey}/toggle?enabled=${enabled}`, 'POST');
            if (result && result.success) {
                    showResult(`âœ… ä»»åŠ¡å·²${statusText}ï¼`, 'success');
                    // åˆ·æ–°è¡¨æ ¼
                    setTimeout(() => refreshTaskConfigs(), 500);
            } else {
                    showResult(`âŒ æ“ä½œå¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡
        let currentExecutionTaskKey = null; // å½“å‰è¦æ‰§è¡Œçš„ä»»åŠ¡é”®
        let pollingIntervals = new Map(); // å­˜å‚¨è½®è¯¢å®šæ—¶å™¨
        let isPollingActive = false; // å…¨å±€è½®è¯¢çŠ¶æ€
        let taskStatusCache = new Map(); // å­˜å‚¨ä»»åŠ¡çŠ¶æ€ç¼“å­˜ï¼Œç”¨äºæ™ºèƒ½è½®è¯¢

        async function manualExecuteTask(taskKey) {
            try {
                currentExecutionTaskKey = taskKey;
                
                if (taskKey === 'customer_service_analysis') {
                    // å®¢æœåˆ†æä»»åŠ¡æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å¯¹è¯æ¡†
                    showDateSelectionModal();
            } else {
                    // å…¶ä»–ä»»åŠ¡ç›´æ¥æ‰§è¡Œ
                    const confirmed = confirm(`ç¡®è®¤æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡ "${taskKey}"ï¼Ÿ`);
                    if (!confirmed) return;
                    
                    showResult(`ğŸš€ æ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡: ${taskKey}...`, 'info');
                    
                    const apiUrl = `/api/v1/tasks/manual-execution/${taskKey}`;
                    const result = await apiRequest(apiUrl, 'POST');
                    
                    if (result && result.success) {
                        const taskId = result.task_id;
                        showResult(`âœ… ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼\nä»»åŠ¡ID: ${taskId || 'N/A'}\n${result.message || ''}\nâ±ï¸ æ­£åœ¨ç›‘æ§ä»»åŠ¡è¿›åº¦...`, 'success');
                        
                        // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨ä»»åŠ¡çŠ¶æ€è½®è¯¢
                        if (taskId) {
                            startTaskPolling(taskId, taskKey);
                        }
                        
                        setTimeout(() => refreshTaskConfigs(), 1000);
                    } else {
                        showResult(`âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡é”™è¯¯:', error);
                showResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function showDateSelectionModal() {
            // è®¾ç½®é»˜è®¤å¼€å§‹æ—¥æœŸä¸º3å¤©å‰ï¼Œç»“æŸæ—¥æœŸä¸ºæ˜¨å¤©
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1);
            const endDateString = endDate.toISOString().split('T')[0];
            
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 3);
            const startDateString = startDate.toISOString().split('T')[0];
            
            document.getElementById('taskStartDate').value = startDateString;
            document.getElementById('taskEndDate').value = endDateString;
            document.getElementById('dateSelectionModal').style.display = 'flex';
        }

        function closeDateSelectionModal() {
            document.getElementById('dateSelectionModal').style.display = 'none';
            currentExecutionTaskKey = null;
        }

        async function confirmTaskExecution() {
            try {
                const startDate = document.getElementById('taskStartDate').value;
                const endDate = document.getElementById('taskEndDate').value;
                
                if (!startDate || !endDate) {
                    showResult('âŒ è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ', 'error');
                    return;
                }

                // éªŒè¯æ—¥æœŸèŒƒå›´
                if (new Date(startDate) >= new Date(endDate)) {
                    showResult('âŒ å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ', 'error');
                    return;
                }

                closeDateSelectionModal();
                showResult(`ğŸš€ æ­£åœ¨æ‰§è¡Œä»»åŠ¡: ${currentExecutionTaskKey} (æ—¶é—´èŒƒå›´: ${startDate} ~ ${endDate})...`, 'info');

                // æ„é€ æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ·»åŠ æ—¶åˆ†ç§’éƒ¨åˆ†
                const startTime = `${startDate}T00:00:00`;
                const endTime = `${endDate}T23:59:59`;

                // æ„é€ URLå‚æ•°
                const params = new URLSearchParams({
                    start_time: startTime,
                    end_time: endTime,
                    loop_analysis: 'true',
                    batch_size: '50'
                });

                // ä½¿ç”¨æ—¶é—´èŒƒå›´API
                const result = await apiRequest(`/api/v1/tasks/full-task-range?${params.toString()}`, 'POST');

                if (result && result.success) {
                    const extractionSummary = result.extraction_summary || {};
                    const analysisSummary = result.analysis_summary || {};
                    
                    const taskId = result.task_id;
                    showResult(`âœ… ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼
ä»»åŠ¡ID: ${taskId || 'N/A'}
æ—¶é—´èŒƒå›´: ${startDate} ~ ${endDate}
æŠ½å–æ•°æ®: ${extractionSummary.extracted || 0} æ¡
æˆåŠŸåˆ†æ: ${analysisSummary.successful || 0} æ¡
â±ï¸ æ­£åœ¨ç›‘æ§ä»»åŠ¡è¿›åº¦...
${result.message || ''}`, 'success');
                    
                    // ä»»åŠ¡å·²å¯åŠ¨ï¼Œå¯ä»¥ç‚¹å‡»æŸ¥çœ‹è®°å½•è¿›è¡ŒçŠ¶æ€ç›‘æ§
                    
                    setTimeout(() => refreshTaskConfigs(), 1000);
                } else {
                    showResult(`âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('ç¡®è®¤ä»»åŠ¡æ‰§è¡Œé”™è¯¯:', error);
                showResult(`âŒ æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
            } finally {
                currentExecutionTaskKey = null;
            }
        }

        // ç»ˆæ­¢ä»»åŠ¡æ‰§è¡Œ
        async function stopTaskExecution(taskKey) {
            // é¦–å…ˆè·å–æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
            try {
                const tasksResult = await apiRequest('/api/v1/tasks/records?limit=10&status=running');
                if (!tasksResult || !tasksResult.success) {
                    showResult('âŒ æ— æ³•è·å–è¿è¡Œä¸­çš„ä»»åŠ¡', 'error');
                return;
            }

                // æŸ¥æ‰¾ä¸è¯¥ä»»åŠ¡é…ç½®ç›¸å…³çš„è¿è¡Œä¸­ä»»åŠ¡
                const runningTasks = tasksResult.data.filter(task => 
                    task.status === 'running' && 
                    (task.task_name.includes(taskKey) || task.task_type.includes(taskKey.split('_')[0]))
                );

                if (runningTasks.length === 0) {
                    showResult(`âš ï¸ ä»»åŠ¡ "${taskKey}" å½“å‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹`, 'warning');
                return;
            }

                // å¦‚æœæœ‰å¤šä¸ªè¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œç»ˆæ­¢æœ€æ–°çš„é‚£ä¸ª
                const taskToStop = runningTasks[0];
                const confirmed = confirm(`ç¡®è®¤ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Ÿ\nä»»åŠ¡ID: ${taskToStop.task_id}\nä»»åŠ¡åç§°: ${taskToStop.task_name}`);
                if (!confirmed) return;

                const result = await apiRequest(`/api/v1/tasks/stop/${taskToStop.task_id}?reason=ç”¨æˆ·æ‰‹åŠ¨ç»ˆæ­¢`, 'POST');
            if (result && result.success) {
                    showResult(`âœ… ä»»åŠ¡å·²ç»ˆæ­¢ï¼\nä»»åŠ¡ID: ${taskToStop.task_id}`, 'success');
                    // åˆ·æ–°è¡¨æ ¼
                    setTimeout(() => refreshTaskConfigs(), 1000);
            } else {
                    showResult(`âŒ ç»ˆæ­¢ä»»åŠ¡å¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè®°å½•
        let currentTaskKey = '';
        let currentTaskName = '';

        async function viewTaskRecords(taskKey, taskName) {
            currentTaskKey = taskKey;
            currentTaskName = taskName;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('taskRecordsModal').style.display = 'block';
            document.getElementById('taskRecordsModalTitle').textContent = `${taskName} - æ‰§è¡Œè®°å½•`;
            
            // åŠ è½½æ•°æ®
            await loadTaskRecords(taskKey);
        }

                async function loadTaskRecords(taskKey) {
            try {
                document.getElementById('taskRecordsModalBody').innerHTML = `
                    <tr>
                        <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                `;

                // æ ¹æ®ä»»åŠ¡keyåŒ¹é…ç›¸å…³çš„æ‰§è¡Œè®°å½•
                let apiUrl = '/api/v1/tasks/records?limit=100';

                const result = await apiRequest(apiUrl);
                if (result && result.success) {
                    // ç›´æ¥ä½¿ç”¨ä»»åŠ¡é…ç½®é”®è¿›è¡Œç²¾ç¡®åŒ¹é…
                    const relatedRecords = result.data.filter(record => {
                        return record.task_config_key === taskKey;
                    });

                    // æŒ‰å¼€å§‹æ—¶é—´å€’åºæ’åˆ—
                    relatedRecords.sort((a, b) => {
                        const timeA = new Date(a.start_time || 0);
                        const timeB = new Date(b.start_time || 0);
                        return timeB - timeA;
                    });

                    renderTaskRecordsModal(relatedRecords);
                    document.getElementById('taskRecordsCount').textContent = `å…±æ‰¾åˆ° ${relatedRecords.length} æ¡æ‰§è¡Œè®°å½•`;
                } else {
                    document.getElementById('taskRecordsModalBody').innerHTML = `
                        <tr>
                            <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                åŠ è½½å¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                document.getElementById('taskRecordsModalBody').innerHTML = `
                    <tr>
                        <td colspan="11" style="padding: 2rem; text-align: center; color: var(--danger-color);">
                            ç½‘ç»œé”™è¯¯: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderTaskRecordsModal(records) {
            const tbody = document.getElementById('taskRecordsModalBody');
            
            if (!records || records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            æš‚æ— æ‰§è¡Œè®°å½•
                        </td>
                    </tr>
                `;
                return;
            }

                        tbody.innerHTML = records.map(record => `
                <tr style="border-bottom: 1px solid var(--border-color); transition: all 0.2s ease; height: 50px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='white'">
                    <td style="padding: 8px; font-family: monospace; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;" title="${record.task_id}">
                        ${record.task_id.substring(0, 12)}...
                    </td>
                    <td style="padding: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;" title="${record.task_name}">
                        <div style="font-weight: 500; font-size: 11px; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis;">${record.task_name.length > 20 ? record.task_name.substring(0, 20) + '...' : record.task_name}</div>
                        ${record.trigger_user ? `<div style="font-size: 9px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis;">${record.trigger_user}</div>` : ''}
                    </td>
                    <td style="padding: 8px; white-space: nowrap; vertical-align: middle;">
                        <span style="padding: 2px 6px; background: ${getStatusBadgeColor(record.status)}; color: white; border-radius: 8px; font-size: 9px; font-weight: 500; box-shadow: var(--shadow-sm);">
                            ${getStatusLabel(record.status)}
                        </span>
                    </td>
                    <td style="padding: 8px; white-space: nowrap; vertical-align: middle; font-size: 10px; color: var(--text-secondary);">${record.trigger_type === 'manual' ? 'æ‰‹åŠ¨' : 'å®šæ—¶'}</td>
                    <td style="padding: 8px; font-size: 10px; white-space: nowrap; vertical-align: middle; color: var(--text-secondary);">${formatDateTime(record.start_time)}</td>
                    <td style="padding: 8px; font-size: 10px; white-space: nowrap; vertical-align: middle; color: var(--text-secondary);">${formatDateTime(record.end_time)}</td>
                    <td style="padding: 8px; white-space: nowrap; vertical-align: middle; font-size: 10px; color: var(--text-secondary);">${(() => {
                        if (record.status === 'running' && record.start_time && !record.duration_seconds) {
                            const startTime = new Date(record.start_time);
                            const now = new Date();
                            const currentDuration = Math.floor((now - startTime) / 1000);
                            return formatDuration(currentDuration);
                        }
                        return formatDuration(record.duration_seconds);
                    })()}</td>
                    <td style="padding: 8px; text-align: center; white-space: nowrap; vertical-align: middle;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <div style="width: 50px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: ${(() => {
                                    const successRecords = record.success_records || 0;
                                    const failedRecords = record.failed_records || 0;
                                    const totalRecords = record.total_records || 0;
                                    let displayProgress;
                                    if (totalRecords > 0 && successRecords === 0 && failedRecords === 0) {
                                        displayProgress = 100;
                                    } else {
                                        displayProgress = record.completion_rate || record.actual_completion_rate || 0;
                                    }
                                    return displayProgress >= 100 ? 'var(--success-color)' : displayProgress >= 50 ? 'var(--warning-color)' : 'var(--danger-color)';
                                })()}; width: ${(() => {
                                    const successRecords = record.success_records || 0;
                                    const failedRecords = record.failed_records || 0;
                                    const totalRecords = record.total_records || 0;
                                    if (totalRecords > 0 && successRecords === 0 && failedRecords === 0) {
                                        return 100;
                                    }
                                    return record.completion_rate || record.actual_completion_rate || 0;
                                })()}%; transition: width 0.3s ease;"></div>
                            </div>
                            <small style="font-size: 9px; color: var(--text-secondary);">${(() => {
                                const successRecords = record.success_records || 0;
                                const failedRecords = record.failed_records || 0;
                                const totalRecords = record.total_records || 0;
                                if (totalRecords > 0 && successRecords === 0 && failedRecords === 0) {
                                    return '100%';
                                }
                                return (record.completion_rate || record.actual_completion_rate || 0).toFixed(1) + '%';
                            })()}</small>
                        </div>
                    </td>
                    <td style="padding: 8px; text-align: center; white-space: nowrap; vertical-align: middle;">
                        <div style="font-size: 10px; line-height: 1.2;">
                            <span style="color: var(--text-primary); font-weight: 600;">æ€»${record.total_records || 0}</span>
                            <span style="color: var(--success-color); margin-left: 4px;">âœ“${record.success_records || 0}</span>
                            <span style="color: var(--danger-color); margin-left: 4px;">âœ—${record.failed_records || 0}</span>
                            ${(record.skipped_records || 0) > 0 ? `<span style="color: var(--warning-color); margin-left: 4px;">â­${record.skipped_records}</span>` : ''}
                        </div>
                    </td>
                    <td style="padding: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; font-size: 10px; color: var(--text-secondary);">
                        ${(() => {
                            const skippedRecords = record.skipped_records || 0;
                            const duplicateRecords = record.duplicate_records || 0;
                            const denoisedRecords = record.denoised_records || 0;
                            if (skippedRecords === 0) return '-';
                            const reasons = [];
                            if (duplicateRecords > 0) reasons.push(`é‡å¤${duplicateRecords}`);
                            if (denoisedRecords > 0) reasons.push(`å»ç‡¥${denoisedRecords}`);
                            const otherSkipped = skippedRecords - duplicateRecords - denoisedRecords;
                            if (otherSkipped > 0) reasons.push(`å…¶ä»–${otherSkipped}`);
                            return reasons.length > 0 ? reasons.join(' ') : 'æ•°æ®é‡å¤';
                        })()}
                    </td>
                    <td style="padding: 8px; text-align: center; white-space: nowrap; vertical-align: middle;">
                        <div style="display: flex; gap: 4px; align-items: center; justify-content: center;">
                            <button onclick="viewTaskDetail('${record.task_id}', '${record.task_name}')" 
                                    class="button button-outline"
                                    style="padding: 2px 6px; font-size: 8px; margin: 0; min-width: 35px;">
                                ${record.status === 'running' ? 'ç›‘æ§' : 'è¯¦æƒ…'}
                            </button>
                            ${(record.can_terminate || (record.status && ['running', 'pending'].includes(record.status))) ? `
                                <button onclick="terminateTask('${record.task_id}', '${record.task_name}', '${record.status}')" 
                                        class="button"
                                        style="padding: 2px 6px; font-size: 8px; margin: 0; min-width: 35px; background: var(--danger-color); color: white; border: 1px solid var(--danger-color);"
                                        onmouseover="this.style.background='#dc2626'; this.style.borderColor='#dc2626';"
                                        onmouseout="this.style.background='var(--danger-color)'; this.style.borderColor='var(--danger-color)';">
                                    ç»ˆæ­¢
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function refreshTaskRecordsModal() {
            if (currentTaskKey) {
                await loadTaskRecords(currentTaskKey);
            }
        }

        // ğŸ”¥ æ–°å¢ï¼šç»ˆæ­¢ä»»åŠ¡åŠŸèƒ½
        async function terminateTask(taskId, taskName, currentStatus) {
            // ç¡®è®¤å¯¹è¯æ¡†
            const statusDisplayMap = {
                'running': 'è¿è¡Œä¸­',
                'pending': 'ç­‰å¾…ä¸­'
            };
            
            const statusText = statusDisplayMap[currentStatus] || currentStatus;
            const confirmMessage = `ç¡®å®šè¦ç»ˆæ­¢ä»»åŠ¡å—ï¼Ÿ\n\nä»»åŠ¡ID: ${taskId}\nä»»åŠ¡åç§°: ${taskName}\nå½“å‰çŠ¶æ€: ${statusText}\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const originalButton = event.target;
                const originalText = originalButton.textContent;
                originalButton.textContent = 'ç»ˆæ­¢ä¸­...';
                originalButton.disabled = true;
                originalButton.style.opacity = '0.6';

                // è°ƒç”¨ç»ˆæ­¢API
                const response = await fetch(`/api/v1/tasks/stop/${encodeURIComponent(taskId)}?reason=${encodeURIComponent('ç”¨æˆ·æ‰‹åŠ¨ç»ˆæ­¢')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // æˆåŠŸç»ˆæ­¢
                    showResult(`âœ… ä»»åŠ¡ç»ˆæ­¢æˆåŠŸ: ${result.message}`, 'success');
                    
                    // åˆ·æ–°ä»»åŠ¡è®°å½•åˆ—è¡¨
                    await refreshTaskRecordsModal();
                    
                } else {
                    // ç»ˆæ­¢å¤±è´¥
                    const errorMsg = result.message || result.detail || 'æœªçŸ¥é”™è¯¯';
                    showResult(`âŒ ä»»åŠ¡ç»ˆæ­¢å¤±è´¥: ${errorMsg}`, 'error');
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    originalButton.textContent = originalText;
                    originalButton.disabled = false;
                    originalButton.style.opacity = '1';
                }

            } catch (error) {
                console.error('ç»ˆæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const button = event.target;
                button.textContent = 'ç»ˆæ­¢';
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        // ğŸ”¥ æ–°å¢ï¼šæ‰¹é‡ç»ˆæ­¢ä»»åŠ¡åŠŸèƒ½ï¼ˆé¢„ç•™ï¼‰
        async function batchTerminateTasks(taskIds) {
            if (!taskIds || taskIds.length === 0) {
                showResult('âŒ è¯·é€‰æ‹©è¦ç»ˆæ­¢çš„ä»»åŠ¡', 'error');
                return;
            }

            const confirmMessage = `ç¡®å®šè¦æ‰¹é‡ç»ˆæ­¢ ${taskIds.length} ä¸ªä»»åŠ¡å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/tasks/stop/batch?reason=' + encodeURIComponent('ç”¨æˆ·æ‰¹é‡ç»ˆæ­¢'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskIds)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showResult(`âœ… æ‰¹é‡ç»ˆæ­¢å®Œæˆ: ${result.message}`, 'success');
                    
                    // åˆ·æ–°ä»»åŠ¡è®°å½•åˆ—è¡¨
                    await refreshTaskRecordsModal();
                    
                } else {
                    const errorMsg = result.message || result.detail || 'æœªçŸ¥é”™è¯¯';
                    showResult(`âŒ æ‰¹é‡ç»ˆæ­¢å¤±è´¥: ${errorMsg}`, 'error');
                }

            } catch (error) {
                console.error('æ‰¹é‡ç»ˆæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function closeTaskRecordsModal() {
            document.getElementById('taskRecordsModal').style.display = 'none';
            currentTaskKey = '';
            currentTaskName = '';
        }

        /**
         * æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å¹¶å¼€å§‹è½®è¯¢ï¼ˆä»…é€‚ç”¨äºè¿è¡Œä¸­çš„ä»»åŠ¡ï¼‰
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {string} taskName - ä»»åŠ¡åç§°
         */
        async function viewTaskDetail(taskId, taskName) {
            try {
                // è·å–ä»»åŠ¡è¯¦æƒ…
                const result = await apiRequest(`/api/v1/tasks/records/${taskId}`, 'GET');
                
                if (result && result.success && result.data) {
                    const taskData = result.data;
                    const status = taskData.status;
                    
                    // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…ä¿¡æ¯
                    const detailsHtml = `
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">ğŸ“‹ ${taskName}</h4>
                            <p style="margin: 0; color: var(--text-secondary); font-family: monospace; font-size: 0.9rem;">ID: ${taskId}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>çŠ¶æ€:</strong> <span style="color: ${getStatusColor(status)};">${getStatusLabel(status)}</span>
                            </div>
                            <div>
                                <strong>è¿›åº¦:</strong> ${(taskData.completion_rate || 0).toFixed(1)}%
                            </div>
                            <div>
                                <strong>å¼€å§‹æ—¶é—´:</strong> ${formatDateTime(taskData.start_time)}
                            </div>
                            <div>
                                <strong>å¤„ç†é˜¶æ®µ:</strong> ${taskData.process_stage || 'æœªçŸ¥'}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; text-align: center; margin-bottom: 1rem;">
                            <div style="background: var(--bg-primary); padding: 0.5rem; border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--text-primary);">${taskData.total_records || 0}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">æ€»è®¡</div>
                            </div>
                            <div style="background: var(--success-color); color: white; padding: 0.5rem; border-radius: 4px;">
                                <div style="font-weight: 600;">${taskData.success_records || 0}</div>
                                <div style="font-size: 0.8rem;">æˆåŠŸ</div>
                            </div>
                            <div style="background: var(--danger-color); color: white; padding: 0.5rem; border-radius: 4px;">
                                <div style="font-weight: 600;">${taskData.failed_records || 0}</div>
                                <div style="font-size: 0.8rem;">å¤±è´¥</div>
                            </div>
                            <div style="background: var(--warning-color); color: white; padding: 0.5rem; border-radius: 4px;">
                                <div style="font-weight: 600;">${taskData.skipped_records || 0}</div>
                                <div style="font-size: 0.8rem;">è·³è¿‡</div>
                            </div>
                        </div>
                        
                        ${status === 'running' ? `
                            <div style="background: var(--primary-color); color: white; padding: 0.75rem; border-radius: 6px; text-align: center; margin-bottom: 1rem;">
                                ğŸ”„ å¼€å§‹ç›‘æ§ä»»åŠ¡è¿›åº¦ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
                                <button onclick="stopTaskPolling('${taskId}')" style="margin-left: 1rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; border: 1px solid white; background: transparent; color: white; border-radius: 4px; cursor: pointer;">
                                    åœæ­¢ç›‘æ§
                                </button>
                            </div>
                        ` : ''}
                    `;
                    
                    showResult(detailsHtml, 'info');
                    
                    // å¦‚æœæ˜¯è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œå¼€å§‹è½®è¯¢
                    if (status === 'running') {
                        console.log(`ğŸ”„ å¼€å§‹ç›‘æ§ä»»åŠ¡è¿›åº¦: ${taskId}`);
                        await startTaskPolling(taskId, taskData.task_config_key || taskData.task_type);
                    }
                    
                } else {
                    showResult(`âŒ æ— æ³•è·å–ä»»åŠ¡è¯¦æƒ…: ${result?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
                showResult(`âŒ æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–çŠ¶æ€é¢œè‰²
        function getStatusColor(status) {
            const colors = {
                'running': '#2196F3',
                'completed': '#4CAF50', 
                'failed': '#f44336',
                'cancelled': '#FF9800'
            };
            return colors[status] || '#6c757d';
        }

        // ç¼–è¾‘ä»»åŠ¡é…ç½®
        function editTaskConfig(taskKey) {
            showTaskConfigEditModal(taskKey);
        }

        // æ˜¾ç¤ºä»»åŠ¡é…ç½®ç¼–è¾‘æ¨¡æ€æ¡†
        function showTaskConfigEditModal(taskKey) {
            // è·å–å½“å‰é…ç½®
            const config = currentTaskConfigs.find(c => c.task_key === taskKey);
            if (!config) {
                showResult('âŒ æ‰¾ä¸åˆ°ä»»åŠ¡é…ç½®', 'error');
                return;
            }
            
            const modal = document.getElementById('taskConfigEditModal') || createTaskConfigEditModal();
            
            // ğŸš€ åˆ¤æ–­å½“å‰ä½¿ç”¨çš„è°ƒåº¦æ¨¡å¼
            const hasCron = config.schedule_cron && config.schedule_cron.trim();
            const scheduleMode = hasCron ? 'cron' : 'interval';
            
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('editTaskName').textContent = config.task_name;
            document.getElementById('editTaskKey').textContent = config.task_key;
            
            // è®¾ç½®è°ƒåº¦æ¨¡å¼
            document.getElementById('scheduleMode').value = scheduleMode;
            
            if (scheduleMode === 'cron') {
                // CRONæ¨¡å¼
                document.getElementById('cronInput').value = config.schedule_cron || '';
                showCronMode();
            } else {
                // é—´éš”æ¨¡å¼
                const currentSeconds = config.schedule_interval;
                let displayValue = currentSeconds;
                let selectedUnit = 'seconds';
                
                if (currentSeconds >= 86400 && currentSeconds % 86400 === 0) {
                    displayValue = currentSeconds / 86400;
                    selectedUnit = 'days';
                } else if (currentSeconds >= 3600 && currentSeconds % 3600 === 0) {
                    displayValue = currentSeconds / 3600;
                    selectedUnit = 'hours';
                } else if (currentSeconds >= 60 && currentSeconds % 60 === 0) {
                    displayValue = currentSeconds / 60;
                    selectedUnit = 'minutes';
                }
                
                document.getElementById('editIntervalValue').value = displayValue;
                document.getElementById('editIntervalUnit').value = selectedUnit;
                showIntervalMode();
            }
            
            modal.style.display = 'flex';
            currentEditingTaskKey = taskKey;
        }

        // åˆ›å»ºä»»åŠ¡é…ç½®ç¼–è¾‘æ¨¡æ€æ¡†
        function createTaskConfigEditModal() {
            const modal = document.createElement('div');
            modal.id = 'taskConfigEditModal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(92, 100, 244, 0.1);
                backdrop-filter: blur(8px);
                z-index: 1000;
                justify-content: center;
                align-items: center;
            `;

            modal.innerHTML = `
                <div onclick="event.stopPropagation()" style="background: white; border-radius: 16px; padding: 2rem; max-width: 520px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--primary-color);">âš™ï¸</span>
                            ç¼–è¾‘ä»»åŠ¡é…ç½®
                        </h3>
                        <button onclick="closeTaskConfigEditModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); padding: 8px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='none'">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius-md);">
                        <div style="margin-bottom: 0.75rem;">
                            <strong style="color: var(--text-primary);">ä»»åŠ¡åç§°ï¼š</strong> 
                            <span id="editTaskName" style="color: var(--text-secondary);"></span>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">ä»»åŠ¡æ ‡è¯†ï¼š</strong> 
                            <span id="editTaskKey" style="font-family: 'Monaco', 'Menlo', monospace; color: var(--text-secondary); background: white; padding: 0.125rem 0.25rem; border-radius: 3px; font-size: 0.85rem;"></span>
                        </div>
                    </div>

                    <!-- ğŸš€ è°ƒåº¦æ¨¡å¼é€‰æ‹©å™¨ -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary);">ğŸ”„ è°ƒåº¦æ¨¡å¼</label>
                        <select id="scheduleMode" onchange="toggleScheduleMode()"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white; font-size: 1rem; cursor: pointer; transition: border-color 0.2s;"
                                onfocus="this.style.borderColor='var(--primary-color)'"
                                onblur="this.style.borderColor='var(--border-color)'">
                            <option value="interval">é—´éš”è°ƒåº¦ - æŒ‰å›ºå®šæ—¶é—´é—´éš”æ‰§è¡Œ</option>
                            <option value="cron">CRONè°ƒåº¦ - ä½¿ç”¨CRONè¡¨è¾¾å¼ç²¾ç¡®æ§åˆ¶</option>
                        </select>
                    </div>

                    <!-- ğŸš€ CRONæ¨¡å¼ç•Œé¢ -->
                    <div id="cronModeDiv" style="display: none; margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary);">â° CRONè¡¨è¾¾å¼</label>
                        <div style="margin-bottom: 0.75rem;">
                            <input type="text" id="cronInput" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; font-family: 'Monaco', 'Menlo', monospace; transition: border-color 0.2s;"
                                   placeholder="0 9 * * 1-5  (å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹)"
                                   oninput="validateCronExpression()"
                                   onfocus="this.style.borderColor='var(--primary-color)'"
                                   onblur="this.style.borderColor='var(--border-color)'">
                        </div>
                        <div id="cronValidation" style="margin-bottom: 0.75rem;"></div>
                        <div id="cronPreview" style="margin-bottom: 0.75rem;"></div>
                        
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.9rem;">ğŸ¯ CRONç¤ºä¾‹ï¼š</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                <button type="button" onclick="setCronExample('0 */2 * * *')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">æ¯2å°æ—¶</button>
                                <button type="button" onclick="setCronExample('0 9 * * 1-5')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">å·¥ä½œæ—¥9ç‚¹</button>
                                <button type="button" onclick="setCronExample('*/30 * * * *')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">æ¯30åˆ†é’Ÿ</button>
                                <button type="button" onclick="setCronExample('0 0 */3 * *')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">æ¯3å¤©</button>
                                <button type="button" onclick="setCronExample('0 8,12,18 * * *')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">ä¸‰é¤æ—¶é—´</button>
                            </div>
                        </div>
                        
                        <div style="padding: 0.75rem; background: #e0f2fe; border-radius: var(--radius-md); border-left: 4px solid #0288d1;">
                            <small style="color: #01579b; font-weight: 500;">
                                ğŸ“ <strong>CRONæ ¼å¼:</strong> åˆ†é’Ÿ å°æ—¶ æ—¥æœŸ æœˆä»½ æ˜ŸæœŸ (ä¾‹: 0 9 * * 1-5 = å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹)
                            </small>
                        </div>
                    </div>

                    <!-- ğŸ”„ é—´éš”æ¨¡å¼ç•Œé¢ -->
                    <div id="intervalModeDiv" style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary);">â° è°ƒåº¦é—´éš”</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" id="editIntervalValue" min="1" step="1" 
                                   style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; transition: border-color 0.2s;"
                                   placeholder="è¾“å…¥æ•°å€¼"
                                   onfocus="this.style.borderColor='var(--primary-color)'"
                                   onblur="this.style.borderColor='var(--border-color)'">
                            <select id="editIntervalUnit" 
                                    style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white; font-size: 1rem; cursor: pointer; transition: border-color 0.2s;"
                                    onfocus="this.style.borderColor='var(--primary-color)'"
                                    onblur="this.style.borderColor='var(--border-color)'">
                                <option value="seconds">ç§’</option>
                                <option value="minutes">åˆ†é’Ÿ</option>
                                <option value="hours">å°æ—¶</option>
                                <option value="days">å¤©</option>
                            </select>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.9rem;">ğŸ¯ å¿«é€Ÿè®¾ç½®ï¼š</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" onclick="setQuickInterval(30, 'minutes')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">30åˆ†é’Ÿ</button>
                                <button type="button" onclick="setQuickInterval(1, 'hours')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">1å°æ—¶</button>
                                <button type="button" onclick="setQuickInterval(4, 'hours')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">4å°æ—¶</button>
                                <button type="button" onclick="setQuickInterval(6, 'hours')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">6å°æ—¶</button>
                                <button type="button" onclick="setQuickInterval(12, 'hours')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">12å°æ—¶</button>
                                <button type="button" onclick="setQuickInterval(1, 'days')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">1å¤©</button>
                                <button type="button" onclick="setQuickInterval(3, 'days')" class="button" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">3å¤©</button>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                            <small style="color: #92400e; font-weight: 500;">
                                ğŸ’¡ <strong>å»ºè®®:</strong> ä¸€èˆ¬ä»»åŠ¡å»ºè®®4-6å°æ—¶ï¼Œæ•°æ®å¯†é›†å‹ä»»åŠ¡å»ºè®®1-2å¤©
                            </small>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 2rem;">
                        <button onclick="closeTaskConfigEditModal()" 
                                class="button" 
                                style="background: var(--text-secondary); color: white; padding: 0.75rem 1.5rem;">å–æ¶ˆ</button>
                        <button onclick="saveTaskConfigEdit()" 
                                class="button button-primary" 
                                style="padding: 0.75rem 1.5rem;">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </div>
            `;

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeTaskConfigEditModal();
                }
            };

            document.body.appendChild(modal);
            return modal;
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeTaskConfigEditModal() {
            const modal = document.getElementById('taskConfigEditModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentEditingTaskKey = null;
        }

        // ä¿å­˜ä»»åŠ¡é…ç½®ç¼–è¾‘
        function saveTaskConfigEdit() {
            const scheduleMode = document.getElementById('scheduleMode').value;
            let updates = {};

            if (scheduleMode === 'cron') {
                // ğŸš€ CRONæ¨¡å¼
                const cronExpr = document.getElementById('cronInput').value.trim();
                
                if (!cronExpr) {
                    showResult('âŒ è¯·è¾“å…¥CRONè¡¨è¾¾å¼', 'error');
                    return;
                }

                // éªŒè¯CRONè¡¨è¾¾å¼
                if (!isValidCronExpression(cronExpr)) {
                    showResult('âŒ CRONè¡¨è¾¾å¼æ ¼å¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ ¼å¼', 'error');
                    return;
                }

                updates.schedule_cron = cronExpr;
                updates.schedule_interval = null; // æ¸…ç©ºinterval
                
            } else {
                // ğŸ”„ é—´éš”æ¨¡å¼
                const value = parseInt(document.getElementById('editIntervalValue').value);
                const unit = document.getElementById('editIntervalUnit').value;

                if (!value || value <= 0) {
                    showResult('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼', 'error');
                    return;
                }

                // è½¬æ¢ä¸ºç§’
                let seconds = value;
                switch (unit) {
                    case 'minutes':
                        seconds = value * 60;
                        break;
                    case 'hours':
                        seconds = value * 3600;
                        break;
                    case 'days':
                        seconds = value * 86400;
                        break;
                }

                // éªŒè¯åˆç†èŒƒå›´
                if (seconds < 60) {
                    showResult('âŒ è°ƒåº¦é—´éš”ä¸èƒ½å°‘äº1åˆ†é’Ÿ', 'error');
                    return;
                }

                if (seconds > 86400 * 30) {
                    showResult('âŒ è°ƒåº¦é—´éš”ä¸èƒ½è¶…è¿‡30å¤©', 'error');
                    return;
                }

                updates.schedule_interval = seconds;
                updates.schedule_cron = null; // æ¸…ç©ºcron
            }

            updateTaskConfig(currentEditingTaskKey, updates);
            closeTaskConfigEditModal();
        }

        // å¿«é€Ÿè®¾ç½®æ—¶é—´é—´éš”
        function setQuickInterval(value, unit) {
            document.getElementById('editIntervalValue').value = value;
            document.getElementById('editIntervalUnit').value = unit;
            
            // æ·»åŠ è§†è§‰åé¦ˆ
            const input = document.getElementById('editIntervalValue');
            const select = document.getElementById('editIntervalUnit');
            
            input.style.borderColor = 'var(--success-color)';
            select.style.borderColor = 'var(--success-color)';
            
            setTimeout(() => {
                input.style.borderColor = 'var(--border-color)';
                select.style.borderColor = 'var(--border-color)';
            }, 1000);
        }

        // å…¨å±€å˜é‡
        let currentEditingTaskKey = null;
        let currentTaskConfigs = [];

        // æ›´æ–°ä»»åŠ¡é…ç½®
        async function updateTaskConfig(taskKey, updates) {
            try {
                const result = await apiRequest(`/api/v1/tasks/configs/${taskKey}`, 'PUT', updates);
                if (result && result.success) {
                    showResult(`âœ… ${result.message}`, 'success');
                    // åˆ·æ–°è¡¨æ ¼
                    setTimeout(() => refreshTaskConfigs(), 500);
                } else {
                    showResult(`âŒ æ›´æ–°å¤±è´¥: ${result?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // ğŸš€ ==================== CRONåŠŸèƒ½ç›¸å…³å‡½æ•° ====================

        // åˆ‡æ¢è°ƒåº¦æ¨¡å¼
        function toggleScheduleMode() {
            const scheduleMode = document.getElementById('scheduleMode').value;
            if (scheduleMode === 'cron') {
                showCronMode();
            } else {
                showIntervalMode();
            }
        }

        // æ˜¾ç¤ºCRONæ¨¡å¼ç•Œé¢
        function showCronMode() {
            document.getElementById('cronModeDiv').style.display = 'block';
            document.getElementById('intervalModeDiv').style.display = 'none';
            
            // è§¦å‘ä¸€æ¬¡éªŒè¯ä»¥æ˜¾ç¤ºå½“å‰çŠ¶æ€
            setTimeout(() => validateCronExpression(), 100);
        }

        // æ˜¾ç¤ºé—´éš”æ¨¡å¼ç•Œé¢
        function showIntervalMode() {
            document.getElementById('cronModeDiv').style.display = 'none';
            document.getElementById('intervalModeDiv').style.display = 'block';
        }

        // è®¾ç½®CRONç¤ºä¾‹
        function setCronExample(cronExpr) {
            document.getElementById('cronInput').value = cronExpr;
            validateCronExpression();
        }

        // éªŒè¯CRONè¡¨è¾¾å¼ï¼ˆå‰ç«¯ç®€å•éªŒè¯ï¼‰
        function isValidCronExpression(cronExpr) {
            if (!cronExpr || !cronExpr.trim()) return false;
            
            const parts = cronExpr.trim().split(/\s+/);
            if (parts.length !== 5) return false;
            
            // ç®€å•çš„å­—æ®µéªŒè¯
            const ranges = [
                [0, 59],  // åˆ†é’Ÿ
                [0, 23],  // å°æ—¶
                [1, 31],  // æ—¥
                [1, 12],  // æœˆ
                [0, 6]    // å‘¨
            ];
            
            for (let i = 0; i < parts.length; i++) {
                const field = parts[i];
                if (field === '*') continue;
                
                // éªŒè¯æ•°å€¼èŒƒå›´ï¼ˆç®€åŒ–ç‰ˆï¼‰
                if (/^\d+$/.test(field)) {
                    const num = parseInt(field);
                    if (num < ranges[i][0] || num > ranges[i][1]) {
                        return false;
                    }
                }
                // å…¶ä»–æ ¼å¼ï¼ˆèŒƒå›´ã€åˆ—è¡¨ã€æ­¥é•¿ï¼‰æš‚æ—¶è®¤ä¸ºæœ‰æ•ˆ
            }
            
            return true;
        }

        // å®æ—¶éªŒè¯CRONè¡¨è¾¾å¼
        async function validateCronExpression() {
            const cronInput = document.getElementById('cronInput');
            const cronValidation = document.getElementById('cronValidation');
            const cronPreview = document.getElementById('cronPreview');
            
            const cronExpr = cronInput.value.trim();
            
            if (!cronExpr) {
                cronValidation.innerHTML = '';
                cronPreview.innerHTML = '';
                cronInput.style.borderColor = 'var(--border-color)';
                return;
            }
            
            // å‰ç«¯å¿«é€ŸéªŒè¯
            if (!isValidCronExpression(cronExpr)) {
                cronValidation.innerHTML = `
                    <div style="padding: 0.5rem; background: #fee2e2; border-radius: var(--radius-md); border-left: 4px solid #dc2626;">
                        <small style="color: #dc2626; font-weight: 500;">âŒ æ ¼å¼é”™è¯¯ï¼šCRONè¡¨è¾¾å¼å¿…é¡»åŒ…å«5ä¸ªå­—æ®µ</small>
                    </div>
                `;
                cronPreview.innerHTML = '';
                cronInput.style.borderColor = '#dc2626';
                return;
            }
            
            // è°ƒç”¨åç«¯éªŒè¯API
            try {
                const response = await apiRequest('/api/v1/tasks/validate-cron', 'POST', {
                    cron_expression: cronExpr
                });
                
                if (response && response.success) {
                    // éªŒè¯æˆåŠŸ
                    cronValidation.innerHTML = `
                        <div style="padding: 0.5rem; background: #dcfce7; border-radius: var(--radius-md); border-left: 4px solid #16a34a;">
                            <small style="color: #16a34a; font-weight: 500;">âœ… ${response.message}</small>
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºæè¿°å’Œé¢„è§ˆæ—¶é—´
                    let previewHtml = '';
                    if (response.description) {
                        previewHtml += `<div style="margin-bottom: 0.5rem;"><strong>æè¿°ï¼š</strong>${response.description}</div>`;
                    }
                    if (response.next_runs && response.next_runs.length > 0) {
                        previewHtml += `
                            <div><strong>æ¥ä¸‹æ¥æ‰§è¡Œæ—¶é—´ï¼š</strong></div>
                            <ul style="margin: 0.25rem 0; padding-left: 1.25rem; font-size: 0.9rem; color: var(--text-secondary);">
                                ${response.next_runs.map(time => `<li>${time}</li>`).join('')}
                            </ul>
                        `;
                    }
                    
                    cronPreview.innerHTML = `
                        <div style="padding: 0.75rem; background: #f0f9ff; border-radius: var(--radius-md); border: 1px solid #0ea5e9;">
                            <div style="font-size: 0.9rem; color: #0369a1;">${previewHtml}</div>
                        </div>
                    `;
                    
                    cronInput.style.borderColor = '#16a34a';
                    
                } else {
                    // éªŒè¯å¤±è´¥
                    cronValidation.innerHTML = `
                        <div style="padding: 0.5rem; background: #fee2e2; border-radius: var(--radius-md); border-left: 4px solid #dc2626;">
                            <small style="color: #dc2626; font-weight: 500;">âŒ ${response.message || 'éªŒè¯å¤±è´¥'}</small>
                        </div>
                    `;
                    cronPreview.innerHTML = '';
                    cronInput.style.borderColor = '#dc2626';
                }
                
            } catch (error) {
                console.warn('CRONéªŒè¯APIè°ƒç”¨å¤±è´¥:', error);
                // APIè°ƒç”¨å¤±è´¥æ—¶ï¼Œä½¿ç”¨å‰ç«¯éªŒè¯ç»“æœ
                cronValidation.innerHTML = `
                    <div style="padding: 0.5rem; background: #dcfce7; border-radius: var(--radius-md); border-left: 4px solid #16a34a;">
                        <small style="color: #16a34a; font-weight: 500;">âœ… åŸºæœ¬æ ¼å¼éªŒè¯é€šè¿‡</small>
                    </div>
                `;
                cronPreview.innerHTML = '';
                cronInput.style.borderColor = '#16a34a';
            }
        }







        // è·å–ä»»åŠ¡ç±»å‹æ ‡ç­¾é¢œè‰²
        function getTaskTypeBadgeColor(type) {
            const colors = {
                'batch_analysis': '#1976d2',
                'manual_analysis': '#7b1fa2',
                'manual_extraction': '#f57c00',
                'full_task': '#4caf50',
                'full_task_range': '#2e7d32',
                'cleanup': '#d32f2f'
            };
            return colors[type] || '#616161';
        }

        // è·å–ä»»åŠ¡ç±»å‹æ ‡ç­¾æ–‡æœ¬
        function getTaskTypeLabel(type) {
            const labels = {
                'batch_analysis': 'å®šæ—¶åˆ†æ',
                'manual_analysis': 'æ‰‹åŠ¨åˆ†æ',
                'manual_extraction': 'æ‰‹åŠ¨æŠ½å–',
                'full_task': 'å®Œæ•´æµç¨‹',
                'full_task_range': 'è‡ªå®šä¹‰èŒƒå›´',
                'cleanup': 'æ¸…ç†ä»»åŠ¡'
            };
            return labels[type] || type;
        }

        // è·å–çŠ¶æ€æ ‡ç­¾é¢œè‰²
        function getStatusBadgeColor(status) {
            const colors = {
                'running': '#1976d2',
                'completed': '#2e7d32',
                'failed': '#c62828',
                'cancelled': '#7b1fa2'
            };
            return colors[status] || '#616161';
        }

        // è·å–çŠ¶æ€æ ‡ç­¾æ–‡æœ¬
        function getStatusLabel(status) {
            const labels = {
                'running': 'è¿è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return labels[status] || status;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ ¼å¼åŒ–è°ƒåº¦æ˜¾ç¤º
        function formatScheduleDisplay(config) {
            if (!config) return '-';
            
            // ä¼˜å…ˆä½¿ç”¨åç«¯å·²æ ¼å¼åŒ–çš„æ˜¾ç¤º
            if (config.schedule_display) {
                return config.schedule_display;
            }
            
            // å¦‚æœæœ‰CRONè¡¨è¾¾å¼ï¼Œæ˜¾ç¤ºCRON
            if (config.schedule_cron) {
                return `CRON: ${config.schedule_cron}`;
            }
            
            // æ ¹æ®é—´éš”æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤º
            if (config.schedule_interval) {
                const interval = config.schedule_interval;
                if (interval < 60) {
                    return `é—´éš”: ${interval}ç§’`;
                } else if (interval < 3600) {
                    const minutes = Math.floor(interval / 60);
                    return `é—´éš”: ${minutes}åˆ†é’Ÿ`;
                } else if (interval < 86400) {
                    const hours = Math.floor(interval / 3600);
                    return `é—´éš”: ${hours}å°æ—¶`;
                } else {
                    const days = Math.floor(interval / 86400);
                    return `é—´éš”: ${days}å¤©`;
                }
            }
            
            return '-';
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´
        function formatDuration(seconds) {
            if (!seconds) return '-';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // æ ¼å¼åŒ–é—´éš”æ—¶é—´
        function formatInterval(seconds) {
            if (!seconds) return '-';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    const remainingHours = hours % 24;
                    return remainingHours > 0 ? `${days}å¤©${remainingHours}å°æ—¶` : `${days}å¤©`;
                }
                return `${hours}å°æ—¶`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿ`;
            } else {
                return `${seconds}ç§’`;
            }
        }

        // è·å–ä»»åŠ¡å¤„ç†å™¨æ ‡ç­¾é¢œè‰²
        function getTaskHandlerBadgeColor(handler) {
            const colors = {
                'batch_analysis': '#1976d2',
                'cleanup': '#d32f2f',
                'manual_analysis': '#7b1fa2',
                'extraction': '#f57c00'
            };
            return colors[handler] || '#616161';
        }

        // è·å–ä»»åŠ¡å¤„ç†å™¨æ ‡ç­¾æ–‡æœ¬
        function getTaskHandlerLabel(handler) {
            const labels = {
                'batch_analysis': 'æ‰¹é‡åˆ†æ',
                'cleanup': 'æ•°æ®æ¸…ç†',
                'manual_analysis': 'æ‰‹åŠ¨åˆ†æ',
                'extraction': 'æ•°æ®æŠ½å–'
            };
            return labels[handler] || handler;
        }

        // è‡ªåŠ¨è®¾ç½®APIåŸºç¡€åœ°å€
        function autoSetBaseUrl() {
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            const protocol = window.location.protocol;
            
            // å¦‚æœå½“å‰é¡µé¢æœ‰ç«¯å£å·ï¼Œåˆ™ä½¿ç”¨å½“å‰ç«¯å£
            if (currentPort) {
                const autoUrl = `${protocol}//${currentHost}:${currentPort}`;
                document.getElementById('baseUrl').value = autoUrl;
            }
        }

        // ç®€å•çš„å¥åº·æ£€æŸ¥
        async function checkSystemHealth() {
            try {
                await apiRequest('/health');
            } catch (error) {
                console.log('ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        async function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/static/login.html';
                return false;
            }

            try {
                const response = await fetch('/api/v1/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token verification failed');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error('Invalid token');
                }

                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const username = localStorage.getItem('username') || result.username;
                const userInfo = document.createElement('div');
                userInfo.innerHTML = `
                    <div style="position: fixed; top: 10px; right: 10px; background: var(--bg-primary); padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9rem; z-index: 1000;">
                        <span style="color: var(--text-secondary);">æ¬¢è¿ï¼Œ</span>
                        <strong style="color: var(--text-primary);">${username}</strong>
                        <button onclick="logout()" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ç™»å‡º
                        </button>
                    </div>
                `;
                document.body.appendChild(userInfo);

                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('auth_token');
                localStorage.removeItem('username');
                window.location.href = '/static/login.html';
                return false;
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            const confirmed = confirm('ç¡®è®¤ç™»å‡ºå—ï¼Ÿ');
            if (!confirmed) return;

            try {
                await fetch('/api/v1/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
            } catch (error) {
                console.log('Logout request failed, but continuing...');
            }

            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            window.location.href = '/static/login.html';
        }

        // ğŸ”¥ æ–°å¢ï¼šä»»åŠ¡çŠ¶æ€è½®è¯¢ç›¸å…³å‡½æ•°
        
        /**
         * å¯åŠ¨ä»»åŠ¡çŠ¶æ€è½®è¯¢
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {string} taskKey - ä»»åŠ¡é”®å
         */
        async function startTaskPolling(taskId, taskKey) {
            console.log(`ğŸ”„ å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€: ${taskId}`);
            
            // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
            if (pollingIntervals.has(taskId)) {
                clearInterval(pollingIntervals.get(taskId));
            }
            
            isPollingActive = true;
            updatePollingStatusDisplay();
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡çŠ¶æ€æ£€æŸ¥
            await checkTaskStatus(taskId, taskKey);
            
            // è®¾ç½®å®šæ—¶è½®è¯¢ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…è§¦å‘é™æµï¼‰
            const intervalId = setInterval(async () => {
                try {
                    await checkTaskStatus(taskId, taskKey);
                } catch (error) {
                    console.error(`è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${taskId}`, error);
                    stopTaskPolling(taskId);
                }
            }, 5000);
            
            pollingIntervals.set(taskId, intervalId);
        }
        
        /**
         * æ£€æŸ¥å•ä¸ªä»»åŠ¡çŠ¶æ€
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {string} taskKey - ä»»åŠ¡é”®å
         */
        async function checkTaskStatus(taskId, taskKey) {
            try {
                const result = await apiRequest(`/api/v1/tasks/records/${taskId}`, 'GET');
                
                if (result && result.success && result.data) {
                    const taskData = result.data;
                    const status = taskData.status;
                    const completionRate = taskData.completion_rate || 0;
                    const processStage = taskData.process_stage || 'æœªçŸ¥é˜¶æ®µ';
                    
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    updateTaskProgressDisplay(taskId, taskKey, taskData);
                    
                    // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
                    if (status === 'completed') {
                        stopTaskPolling(taskId);
                        showTaskCompletionResult(taskId, taskKey, taskData);
                    } else if (status === 'failed' || status === 'cancelled') {
                        stopTaskPolling(taskId);
                        showTaskFailureResult(taskId, taskKey, taskData);
                    }
                    
                    // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    refreshTaskConfigs();
                } else {
                    console.warn(`æ— æ³•è·å–ä»»åŠ¡çŠ¶æ€: ${taskId}`);
                }
            } catch (error) {
                console.error(`æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${taskId}`, error);
                throw error;
            }
        }
        
        /**
         * åœæ­¢ä»»åŠ¡è½®è¯¢
         * @param {string} taskId - ä»»åŠ¡ID
         */
        function stopTaskPolling(taskId) {
            if (pollingIntervals.has(taskId)) {
                clearInterval(pollingIntervals.get(taskId));
                pollingIntervals.delete(taskId);
                console.log(`â¹ï¸ åœæ­¢è½®è¯¢ä»»åŠ¡çŠ¶æ€: ${taskId}`);
            }
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–è½®è¯¢åœ¨è¿è¡Œ
            if (pollingIntervals.size === 0) {
                isPollingActive = false;
                updatePollingStatusDisplay();
            }
        }
        
        /**
         * åœæ­¢æ‰€æœ‰è½®è¯¢
         */
        function stopAllPolling() {
            pollingIntervals.forEach((intervalId, taskId) => {
                clearInterval(intervalId);
                console.log(`â¹ï¸ åœæ­¢è½®è¯¢ä»»åŠ¡çŠ¶æ€: ${taskId}`);
            });
            pollingIntervals.clear();
            isPollingActive = false;
            updatePollingStatusDisplay();
        }
        
        /**
         * æ›´æ–°è½®è¯¢çŠ¶æ€æ˜¾ç¤º
         */
        function updatePollingStatusDisplay() {
            const statusElement = document.getElementById('pollingStatus');
            if (statusElement) {
                if (isPollingActive && pollingIntervals.size > 0) {
                    statusElement.style.display = 'block';
                    const countText = pollingIntervals.size > 1 ? `(${pollingIntervals.size}ä¸ªä»»åŠ¡)` : '';
                    const textSpan = statusElement.querySelector('span:nth-child(2)');
                    if (textSpan) {
                        textSpan.textContent = `æ­£åœ¨ç›‘æ§ä»»åŠ¡è¿›åº¦... ${countText}`;
                    }
                } else {
                    statusElement.style.display = 'none';
                }
            }
        }
        
        /**
         * æ›´æ–°ä»»åŠ¡è¿›åº¦æ˜¾ç¤º
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {string} taskKey - ä»»åŠ¡é”®å
         * @param {object} taskData - ä»»åŠ¡æ•°æ®
         */
        function updateTaskProgressDisplay(taskId, taskKey, taskData) {
            const successRecords = taskData.success_records || 0;
            const failedRecords = taskData.failed_records || 0;
            const skippedRecords = taskData.skipped_records || 0;
            const totalRecords = taskData.total_records || 0;
            
            // ğŸ”¥ ä¿®å¤è¿›åº¦è®¡ç®—é€»è¾‘ï¼šå®Œå…¨ä½¿ç”¨åç«¯è®¡ç®—çš„completion_rateï¼Œä¸åœ¨å‰ç«¯é‡æ–°è®¡ç®—
            // åç«¯å·²ç»æ­£ç¡®å¤„ç†äº†å„ç§è¾¹ç•Œæƒ…å†µï¼ˆæ€»æ•°ä¸º0ã€æŠ½å–é˜¶æ®µè·³è¿‡ç­‰ï¼‰
            const completionRate = taskData.completion_rate || 0;
            
            const processStage = taskData.process_stage || 'å¤„ç†ä¸­';
            
            // è®¡ç®—å½“å‰è€—æ—¶
            let currentDuration = '';
            if (taskData.start_time) {
                const startTime = new Date(taskData.start_time);
                const now = new Date();
                const durationSeconds = Math.floor((now - startTime) / 1000);
                currentDuration = `\nâ±ï¸ å½“å‰è€—æ—¶: ${formatDuration(durationSeconds)}`;
            }
            
            // æ„å»ºè¿›åº¦ä¿¡æ¯
            let progressInfo = `ğŸ“Š ä»»åŠ¡è¿›åº¦æ›´æ–° (${taskId.substring(0, 16)}...)\n`;
            progressInfo += `ğŸ”„ å½“å‰é˜¶æ®µ: ${processStage}\n`;
            progressInfo += `ğŸ“ˆ å®Œæˆè¿›åº¦: ${completionRate.toFixed(1)}%`;
            progressInfo += currentDuration;
            
            if (totalRecords > 0) {
                progressInfo += `\nğŸ“‹ å¤„ç†ç»Ÿè®¡:\n`;
                progressInfo += `  âœ… æˆåŠŸ: ${successRecords} æ¡\n`;
                progressInfo += `  âŒ å¤±è´¥: ${failedRecords} æ¡\n`;
                if (skippedRecords > 0) {
                    progressInfo += `  â­ï¸ è·³è¿‡: ${skippedRecords} æ¡\n`;
                }
                progressInfo += `  ğŸ“Š æ€»è®¡: ${totalRecords} æ¡`;
                
                // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºé‡å¤æ•°æ®ç»Ÿè®¡
                const duplicateRecords = taskData.duplicate_records || 0;
                const extractedRecords = taskData.extracted_records || 0;
                if (duplicateRecords > 0 && extractedRecords > 0) {
                    const duplicateRate = (duplicateRecords / extractedRecords * 100).toFixed(1);
                    progressInfo += `\nğŸ”„ æ•°æ®æŠ½å–ç»Ÿè®¡:\n`;
                    progressInfo += `  ğŸ“¥ æŠ½å–æ€»é‡: ${extractedRecords} æ¡\n`;
                    progressInfo += `  ğŸ†• æ–°å¢æ•°æ®: ${totalRecords} æ¡\n`;
                    progressInfo += `  ğŸ” é‡å¤è¿‡æ»¤: ${duplicateRecords} æ¡ (${duplicateRate}%)`;
                }
            }
            
            // åœ¨ç»“æœåŒºåŸŸæ˜¾ç¤ºè¿›åº¦
            showResult(progressInfo, 'info');
        }
        
        /**
         * æ˜¾ç¤ºä»»åŠ¡å®Œæˆç»“æœ
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {string} taskKey - ä»»åŠ¡é”®å
         * @param {object} taskData - ä»»åŠ¡æ•°æ®
         */
        function showTaskCompletionResult(taskId, taskKey, taskData) {
            const successRecords = taskData.success_records || 0;
            const failedRecords = taskData.failed_records || 0;
            const skippedRecords = taskData.skipped_records || 0;
            const totalRecords = taskData.total_records || 0;
            const durationSeconds = taskData.duration_seconds || 0;
            const durationText = durationSeconds > 0 ? `\nâ±ï¸ æ‰§è¡Œæ—¶é•¿: ${Math.round(durationSeconds)}ç§’` : '';
            
            let completionMessage = `ğŸ‰ ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼\n`;
            completionMessage += `ğŸ“‹ ä»»åŠ¡ID: ${taskId}\n`;
            completionMessage += `ğŸ“Š æœ€ç»ˆç»Ÿè®¡:\n`;
            completionMessage += `  âœ… æˆåŠŸ: ${successRecords} æ¡\n`;
            completionMessage += `  âŒ å¤±è´¥: ${failedRecords} æ¡\n`;
            if (skippedRecords > 0) {
                completionMessage += `  â­ï¸ è·³è¿‡: ${skippedRecords} æ¡\n`;
            }
            completionMessage += `  ğŸ“Š æ€»è®¡: ${totalRecords} æ¡`;
            completionMessage += durationText;
            
            showResult(completionMessage, 'success');
        }
        
        /**
         * æ˜¾ç¤ºä»»åŠ¡å¤±è´¥ç»“æœ
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {string} taskKey - ä»»åŠ¡é”®å
         * @param {object} taskData - ä»»åŠ¡æ•°æ®
         */
        function showTaskFailureResult(taskId, taskKey, taskData) {
            const status = taskData.status;
            const errorMessage = taskData.error_message || 'æœªçŸ¥é”™è¯¯';
            const durationSeconds = taskData.duration_seconds || 0;
            const durationText = durationSeconds > 0 ? `\nâ±ï¸ æ‰§è¡Œæ—¶é•¿: ${Math.round(durationSeconds)}ç§’` : '';
            
            let failureMessage = `âŒ ä»»åŠ¡æ‰§è¡Œ${status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¤±è´¥'}ï¼\n`;
            failureMessage += `ğŸ“‹ ä»»åŠ¡ID: ${taskId}\n`;
            failureMessage += `ğŸ“ é”™è¯¯ä¿¡æ¯: ${errorMessage}`;
            failureMessage += durationText;
            
            showResult(failureMessage, 'error');
        }
        
        /**
         * æ£€æŸ¥æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆä»…ç”¨äºæ˜¾ç¤ºçŠ¶æ€ï¼Œä¸è‡ªåŠ¨å¼€å¯è½®è¯¢ï¼‰
         */
        async function checkForRunningTasks() {
            try {
                console.log('ğŸ” æ£€æŸ¥æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡...');
                const result = await apiRequest('/api/v1/tasks/records?status=running&limit=10', 'GET');
                
                if (result && result.success && result.data && result.data.length > 0) {
                    console.log(`ğŸ“‹ å‘ç° ${result.data.length} ä¸ªæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡`);
                    // åªæ˜¾ç¤ºçŠ¶æ€ï¼Œä¸è‡ªåŠ¨å¼€å¯è½®è¯¢ - ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æŸ¥çœ‹è®°å½•æ¥ç›‘æ§
                } else {
                    console.log('ğŸ“‹ æ²¡æœ‰å‘ç°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡');
                }
            } catch (error) {
                console.error('æ£€æŸ¥è¿è¡Œä¸­ä»»åŠ¡å¤±è´¥:', error);
            }
        }

        // é¡µé¢å¸è½½æ—¶åœæ­¢æ‰€æœ‰è½®è¯¢
        window.addEventListener('beforeunload', function() {
            stopAllPolling();
        });

        
        window.addEventListener('load', async function() {
            // é¦–å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
            const isAuthenticated = await checkAuthStatus();
            if (!isAuthenticated) return;

            autoSetBaseUrl();
            checkSystemHealth();
            // ğŸ”¥ æ–°å¢ï¼šåŠ è½½æ€»å¼€å…³çŠ¶æ€
            loadMasterSwitchStatus();
            // è‡ªåŠ¨åŠ è½½ä»»åŠ¡é…ç½®å’Œç³»ç»Ÿç›‘æ§
            setTimeout(() => {
                refreshTaskConfigs();
                refreshSystemMonitor();
                // æ£€æŸ¥æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡çŠ¶æ€ï¼ˆä¸è‡ªåŠ¨å¼€å¯è½®è¯¢ï¼‰
                checkForRunningTasks();
            }, 1000);
        });
    </script>
</body>
</html>
